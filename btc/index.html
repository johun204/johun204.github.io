<meta charset=utf-8>
<title>BTC</title>
<script src='//d3js.org/d3.v4.min.js'></script>
<script src='billboard.pkgd.min.js'></script>
<link href='./bootstrap/bootstrap.min.css' rel='stylesheet'>
<link href='billboard.min.css' rel='stylesheet'>
<div class='container'>
	<br>
	<div id='chart_option' class='row'>
		<div class='col-auto'>
			<select id='market' class='form-select'></select>
		</div>
		<div class='col-auto'>
			<select id='minute' class='form-select'>
				<option value=1>1분 캔들</option>
				<option value=3>3분 캔들</option>
				<option value=5>5분 캔들</option>
				<option value=10>10분 캔들</option>
				<option value=15>15분 캔들</option>
				<option value=30>30분 캔들</option>
				<option value=60 selected>60분 캔들</option>
				<option value=240>240분 캔들</option>
			</select>
		</div>
		<div class='col-auto'>
			<input type='hidden' id='to'>
			<button class='btn btn-outline-primary' onclick='getJSON(withinit=true)'>조회</button>
		</div>
		<div class='col-auto'>
			<input class='btn-check' type='checkbox' id='refresh' onclick='reload()' autocomplete=false checked>
			<label class='btn btn-outline-primary' for='refresh' id='refresh_label'>자동새로고침</label>
		</div>
	</div>
</div>
<br>
<div id='chart'></div>
<div id='rsi'></div>
<div id='volume'></div>
<div id='binance'></div>
<div id='bithumb'></div>

<script>
var timer, timestamp = 0;
function getMarket(){
	const response = fetch('https://api.upbit.com/v1/market/all');
	return response.then(res => res.json());
}
async function initScreen(){
	var jsondata;
	try {
		jsondata = await getMarket();
		var market = document.getElementById('market');
		for(var i=0;i<jsondata.length;i++){
			if(jsondata[i]['market'].length < 4 || jsondata[i]['market'].substr(0,4) != 'KRW-')continue;
			var opt = document.createElement('option');
			opt.value = jsondata[i]['market'];
			opt.innerHTML = jsondata[i]['korean_name'] + '(' + jsondata[i]['market'].substr(4) + ')';
			market.appendChild(opt);
		}
		if(localStorage.getItem('market') != null)document.getElementById('market').value = localStorage.getItem('market');
		if(localStorage.getItem('minute') != null)document.getElementById('minute').value = localStorage.getItem('minute');
		getJSON(withinit=true);
	}
	catch(error){
		console.log(error);
	}
	timer = setTimeout(reload, 500);
}
function initChart(){
	var chart = bb.generate({
		title: {text: 'Loading data..'},
		data: {columns: []},
		bindto: '#chart'
	});
	document.getElementById('rsi').innerHTML = '';
	document.getElementById('volume').innerHTML = '';
	document.getElementById('binance').innerHTML = '';
	document.getElementById('bithumb').innerHTML = '';
}
function reload(){
	clearTimeout(timer);
	if(document.getElementById('refresh').checked && timestamp > 0){
		document.getElementById('refresh_label').innerText = '자동새로고침 (' + Math.ceil((60000 - (new Date()).getTime() + timestamp)/1000) + ')';
		if((new Date()).getTime() > timestamp + 60000){
			console.log(getJSON());
		}
	}else{
		document.getElementById('refresh_label').innerText = '자동새로고침';
	}
	timer = setTimeout(reload, 500);
}
function getJSON(withinit=false){
	timestamp = (new Date()).getTime();
	if(withinit)initChart();
	localStorage.setItem('market', document.getElementById('market').value);
	localStorage.setItem('minute', document.getElementById('minute').value);
	
	var period = 100;
	if(window.innerWidth > 1500){
		period = 200;
	}else if(window.innerWidth > 1000){
		period = 150;
	}
	
	let url = 'https://johun204.herokuapp.com/getJSON' + '?market=' + document.getElementById('market').value + '&minute=' + document.getElementById('minute').value + '&period=' + period + '&to=' + document.getElementById('to').value + '&' + (new Date().getTime()).toString();
	console.log(url);
	if(document.getElementById('chart_script') != null){
		document.getElementById('chart_script').remove();
	}
	let chart_script = document.createElement('script');
	chart_script.setAttribute('src', url);
	chart_script.setAttribute('id', 'chart_script');
	let head = document.head;
	head.insertBefore(chart_script, head.firstElementChild);
	return true;
}
window.addEventListener('load', initScreen);
</script>
