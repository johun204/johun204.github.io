<title>BTC</title>
<script src='//d3js.org/d3.v4.min.js'></script>
<link rel='stylesheet' href='billboard.min.css'>
<script src='billboard.pkgd.min.js'></script>
<div id='candle_select' style='text-align:center'>
	<select id='market'></select>
	<select id='minute' onchange='getJSON(withinit=true)'>
		<option value=1>1분 캔들</option>
		<option value=3>3분 캔들</option>
		<option value=5>5분 캔들</option>
		<option value=10>10분 캔들</option>
		<option value=15>15분 캔들</option>
		<option value=30>30분 캔들</option>
		<option value=60 selected>60분 캔들</option>
		<option value=240>240분 캔들</option>
	</select>
	<input type='checkbox' id='refresh' checked><label for='refresh' id='refresh_label'>자동새로고침</label>
</div>
<div id='chart'></div>
<div id='rsi'></div>
<div id='volume'></div>
<script>
var timer, timestamp = 0;
function initScreen(){
	fetch("./market.json").then(response => {return response.json();}).then(jsondata => {
		var market = document.getElementById('market');
		for(var i=0;i<jsondata.length;i++){
			if(jsondata[i]['market'].length < 4 || jsondata[i]['market'].substr(0,4) != 'KRW-')continue;
			var opt = document.createElement('option');
			opt.value = jsondata[i]['market'];
			opt.innerHTML = jsondata[i]['korean_name'] + '(' + jsondata[i]['market'].substr(4) + ')';
			market.appendChild(opt);
		}
	});
	getJSON(withinit=true);
	timer = setTimeout(reload, 500);
}
function initChart(){
	var chart = bb.generate({
		title: {text: 'Loading data..'},
		data: {columns: []},
		bindto: '#chart'
	});
	document.getElementById('rsi').innerHTML = '';
	document.getElementById('volume').innerHTML = '';
}
function reload(){
	clearTimeout(timer);
	if(document.getElementById('refresh').checked && timestamp > 0){
		document.getElementById('refresh_label').innerText = '자동새로고침 (' + Math.ceil((10000 - (new Date()).getTime() + timestamp)/1000) + ')';
		if((new Date()).getTime() > timestamp + 10000){
			console.log(getJSON());
		}
	}else{
		document.getElementById('refresh_label').innerText = '자동새로고침';
	}
	timer = setTimeout(reload, 500);
}
function getJSON(withinit=false){
	timestamp = (new Date()).getTime();
	document.getElementById('minute').disabled=true;
	document.getElementById('market').disabled=true;
	if(withinit)initChart();
	let url = 'https://johun204.herokuapp.com/getJSON' + '?minute=' + document.getElementById('minute').value + '&' + (new Date().getTime()).toString();
	if(document.getElementById('chart_script') != null){
		document.getElementById('chart_script').remove();
	}
	let chart_script = document.createElement('script');
	chart_script.setAttribute('src', url);
	chart_script.setAttribute('id', 'chart_script');
	let head = document.head;
	head.insertBefore(chart_script, head.firstElementChild);
	return true;
}
window.addEventListener('load', initScreen);
</script>
