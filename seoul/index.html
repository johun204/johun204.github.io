<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ì§€ë„</title>

	<link rel="icon" type="image/png" sizes="16x16" href="/seoul/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/seoul/favicon-32x32.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/seoul/apple-touch-icon.png">
	<link rel="manifest" href="/seoul/site.webmanifest">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="seoul Meter">
	<link rel="apple-touch-icon" sizes="180x180" href="/seoul/apple-touch-icon.png">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }
        
        .year-controls {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 8px; border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; gap: 8px; white-space: nowrap;
        }
        .year-btn {
            border: none; background: #f0f0f0; padding: 8px 14px;
            border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px;
        }
        .year-btn.active { background: #007bff; color: white; }

        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 45px; height: 45px; border-radius: 50%;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; font-size: 20px; color: #333;
        }
        
        .reset-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255,255,255,0.8); border: 1px solid #ccc;
            padding: 5px 8px; font-size: 10px; border-radius: 5px; cursor: pointer;
			display: none;
        }
        
        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: rgba(0,0,0,0.7); color: white;
            padding: 15px 25px; border-radius: 10px; font-size: 14px; display: none;
        }
    </style>
</head>
<body>

    <div id="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <button class="reset-btn" onclick="clearCache()">ğŸ”„ ë°ì´í„° ê°±ì‹ </button>

    <div class="year-controls">
        <button class="year-btn active" onclick="showYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="showYear('2025', this)">2025</button>
        <button class="year-btn" onclick="showYear('2024', this)">2024</button>
        <button class="year-btn" onclick="showYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()"><i class="fa-solid fa-location-crosshairs"></i></button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <script>
        // 0. LocalForage ì„¤ì • (IndexedDB ì‚¬ìš©)
        localforage.config({
            name: 'SeoulFoodMap',
            storeName: 'map_data_store'
        });

        var map = L.map('map').setView([37.5665, 126.9780], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        var markersLayer = L.markerClusterGroup({
            chunkedLoading: true, maxClusterRadius: 35,
            disableClusteringAtZoom: 16, spiderfyOnMaxZoom: true
        });
        map.addLayer(markersLayer);

        map.locate({setView: true, maxZoom: 15});
        map.on('locationfound', function(e) {
            L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1 }).addTo(map);
        });

        // ==========================================
        // ğŸš€ ëŒ€ìš©ëŸ‰ ì²˜ë¦¬: IndexedDB í™œìš© í•¨ìˆ˜
        // ==========================================
        async function loadDataWithCache(year) {
            const cacheKey = `map_data_${year}`;
            const loadingEl = document.getElementById('loading');
            
            try {
                // 1. ì €ì¥ì†Œ(IndexedDB) í™•ì¸
                // getItemì€ ë¹„ë™ê¸°ì´ë¯€ë¡œ await í•„ìˆ˜
                const cachedData = await localforage.getItem(cacheKey);
                
                if (cachedData) {
                    console.log(`[Cache Hit] ${year}ë…„ ë°ì´í„° (IndexedDB)`);
                    return cachedData; // ì´ë¯¸ ê°ì²´ì´ë¯€ë¡œ íŒŒì‹± ë¶ˆí•„ìš”
                }

                // 2. ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ
                console.log(`[Network] ${year}ë…„ ë°ì´í„° ë‹¤ìš´ë¡œë“œ...`);
                loadingEl.style.display = 'block'; // ë¡œë”© í‘œì‹œ
                
                const response = await fetch(`./map_data_${year}.json`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const json = await response.json();

                // 3. IndexedDBì— ì €ì¥ (ìš©ëŸ‰ ì œí•œ ê±°ì˜ ì—†ìŒ)
                await localforage.setItem(cacheKey, json);
                
                return json;
            } catch (err) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                return [];
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // ==========================================
        
        var mapData = { '2023': [], '2024': [], '2025': [] };

        // ë°ì´í„° ë³‘ë ¬ ë¡œë“œ ì‹œì‘
        (async function init() {
            const results = await Promise.all([
                loadDataWithCache('2023'),
                loadDataWithCache('2024'),
                loadDataWithCache('2025')
            ]);
            
            mapData['2023'] = results[0];
            mapData['2024'] = results[1];
            mapData['2025'] = results[2];
            
            showYear('all', document.querySelector('.year-btn.active'));
        })();

        function renderMap(dataList) {
            markersLayer.clearLayers();
            var newMarkers = [];
            dataList.forEach(item => {
                if (item.lat && item.lng) {
                    var avgPrice = item.visit_count > 0 ? Math.round(item.total_amount / item.visit_count) : 0;
                    var marker = L.marker([item.lat, item.lng]);
                    var popupContent = `
                        <div style="text-align:center; min-width:160px; font-size:13px;">
                            <h3 style="margin:0 0 5px; color:#007bff; font-size:15px;">${item.name}</h3>
                            <p style="margin:0 0 8px; color:#666; font-size:11px;">${item.address}</p>
                            <div style="background:#f8f9fa; padding:8px; border-radius:5px; text-align:left;">
                                <p style="margin:3px 0;">ğŸ’° <b>ì´ ì§‘í–‰ê¸ˆì•¡:</b> ${item.total_amount.toLocaleString()}ì›</p>
                                <p style="margin:3px 0;">ğŸš© <b>ì´ ë°©ë¬¸íšŸìˆ˜:</b> ${item.visit_count}íšŒ</p>
                                <hr style="border:0; border-top:1px dashed #ccc; margin:5px 0;">
                                <p style="margin:3px 0; color:#d63384;">ğŸ’³ <b>1íšŒ í‰ê· :</b> ${avgPrice.toLocaleString()}ì›</p>
                            </div>
                        </div>`;
                    marker.bindPopup(popupContent);
                    newMarkers.push(marker);
                }
            });
            markersLayer.addLayers(newMarkers);
        }

        function showYear(year, btnElement) {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            if (year === 'all') {
                var mergedData = {};
                ['2023', '2024', '2025'].forEach(y => {
                    if(mapData[y]) {
                        mapData[y].forEach(item => {
                            var key = item.name + "|" + item.address;
                            if (!mergedData[key]) {
                                mergedData[key] = { ...item }; 
                            } else {
                                mergedData[key].total_amount += item.total_amount;
                                mergedData[key].visit_count += item.visit_count;
                            }
                        });
                    }
                });
                renderMap(Object.values(mergedData));
            } else {
                renderMap(mapData[year] || []);
            }
        }

        function moveToCurrentLocation() {
            map.locate({setView: true, maxZoom: 16});
        }

        // ìºì‹œ ì‚­ì œ (IndexedDB ë¹„ìš°ê¸°)
        async function clearCache() {
            if(confirm('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì„œë²„ì—ì„œ ìƒˆë¡œ ë°›ì•„ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await localforage.clear(); // ëª¨ë“  í‚¤ ì‚­ì œ
                    alert('ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                    location.reload();
                } catch (err) {
                    console.error(err);
                    alert('ì‚­ì œ ì‹¤íŒ¨');
                }
            }
        }
    </script>
</body>
</html>
