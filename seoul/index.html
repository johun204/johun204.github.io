<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ì§€ë„</title>

	<link rel="icon" type="image/png" sizes="16x16" href="/seoul/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/seoul/favicon-32x32.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/seoul/apple-touch-icon.png">
	<link rel="manifest" href="/seoul/site.webmanifest">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="seoul Meter">
	<link rel="apple-touch-icon" sizes="180x180" href="/seoul/apple-touch-icon.png">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ê¹”ë”í•˜ê²Œ ìœ ì§€ */
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        #map { width: 100%; height: 100vh; z-index: 1; background: #f0f0f0; }
        
        /* í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ */
        .cluster-marker {
            background-color: rgba(66, 133, 244, 0.9); /* íŒŒë€ìƒ‰ */
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        /* ê°œìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€í™” */
        .cluster-marker.medium { background-color: #fb8c00; } /* 50ê°œ ì´ìƒ ì‹ë‹¹ (ì£¼í™©) */
        .cluster-marker.large { background-color: #e53935; }  /* 100ê°œ ì´ìƒ ì‹ë‹¹ (ë¹¨ê°•) */

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ë“¤ */
        .year-controls {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 6px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; gap: 5px; white-space: nowrap;
        }
        .year-btn {
            border: none; background: transparent; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px;
            color: #555; transition: 0.2s;
        }
        .year-btn:hover { background: #f1f1f1; }
        .year-btn.active { background: #212529; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 22px; color: #333;
            display: flex; align-items: center; justify-content: center;
        }
        .reset-btn {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: white; border: 1px solid #ddd;
            padding: 6px 10px; font-size: 11px; border-radius: 8px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #666;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: rgba(0,0,0,0.8); color: white;
            padding: 20px 30px; border-radius: 12px; font-size: 15px; display: none;
            backdrop-filter: blur(2px);
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>
    
    <button class="reset-btn" onclick="clearCache()">
        <i class="fa-solid fa-rotate-right"></i> ë°ì´í„° ê°±ì‹ 
    </button>

    <div class="year-controls">
        <button class="year-btn active" onclick="setYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="setYear('2025', this)">2025</button>
        <button class="year-btn" onclick="setYear('2024', this)">2024</button>
        <button class="year-btn" onclick="setYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>

    <script>
        // 1. ì„¤ì •
        localforage.config({ name: 'SeoulFoodMap', storeName: 'map_data_v4' });
        
        const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 14);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        const gpsLayer = L.layerGroup().addTo(map);

        // ============================================================
        // ğŸš€ Supercluster í•µì‹¬ ì„¤ì • (ì‹ë‹¹ ìˆ˜ vs ë°©ë¬¸ íšŸìˆ˜ êµ¬ë¶„)
        // ============================================================
        const index = new Supercluster({
            radius: 60,
            maxZoom: 18,
            // [map]: ê° ì‹ë‹¹ í¬ì¸íŠ¸ê°€ ê°€ì§ˆ ì†ì„± ì •ì˜
            map: (props) => ({ 
                sumMoney: props.total_amount, 
                sumVisits: props.visit_count 
            }),
            // [reduce]: í´ëŸ¬ìŠ¤í„°ê°€ ë­‰ì¹  ë•Œ ì†ì„±ì„ í•©ì¹˜ëŠ” ë°©ë²•
            // ì—¬ê¸°ì„œ sumVisitsë¥¼ ê³„ì† ë”í•˜ì§€ë§Œ, point_count(ì‹ë‹¹ ìˆ˜)ëŠ” Superclusterê°€ ì•Œì•„ì„œ ì…‰ë‹ˆë‹¤.
            reduce: (accumulated, props) => { 
                accumulated.sumMoney += props.sumMoney; 
                accumulated.sumVisits += props.sumVisits; 
            }
        });

        let markersLayer = L.layerGroup().addTo(map);
        let mapDataMap = {};

        // 2. ë°ì´í„° ë¡œë“œ ë° ìºì‹±
        async function loadDataWithCache(year) {
            const cacheKey = `geo_data_${year}_v2`; // v2: í¬ë§· ë³€ê²½
            const loadingEl = document.getElementById('loading');
            
            try {
                const cached = await localforage.getItem(cacheKey);
                if (cached) return cached;

                loadingEl.style.display = 'block';
                const res = await fetch(`./map_data_${year}.json`);
                if (!res.ok) throw new Error('File not found');
                const json = await res.json();

                // GeoJSON ë³€í™˜
                const geoJsonPoints = json
                    .filter(item => item.lat && item.lng)
                    .map(item => ({
                        type: 'Feature',
                        properties: {
                            name: item.name,
                            address: item.address,
                            total_amount: item.total_amount,
                            visit_count: item.visit_count
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [item.lng, item.lat]
                        }
                    }));

                await localforage.setItem(cacheKey, geoJsonPoints);
                return geoJsonPoints;

            } catch (err) {
                console.error(err);
                return [];
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        (async function init() {
            const results = await Promise.all([
                loadDataWithCache('2023'),
                loadDataWithCache('2024'),
                loadDataWithCache('2025')
            ]);
            mapDataMap['2023'] = results[0];
            mapDataMap['2024'] = results[1];
            mapDataMap['2025'] = results[2];
            setYear('all', document.querySelector('.year-btn.active'));
        })();


        // 3. ë°ì´í„° ë³‘í•© (Aggregation)
        // "ê°™ì€ ì‹ë‹¹"ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” ê³¼ì • (í•„ìˆ˜)
        function aggregateData(geoJsonPoints) {
            const mergedMap = {};

            geoJsonPoints.forEach(pt => {
                const props = pt.properties;
                // ì´ë¦„ì—ì„œ ê³µë°±ì œê±°, (ì£¼) ì œê±° ë“±ìœ¼ë¡œ ì •ê·œí™”í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
                const cleanName = props.name.replace(/\(ì£¼\)/g, '').trim(); 
                const key = `${cleanName}|${props.address}`; 

                if (!mergedMap[key]) {
                    mergedMap[key] = {
                        type: 'Feature',
                        properties: { ...props }, // name, address, total_amount, visit_count
                        geometry: { ...pt.geometry }
                    };
                } else {
                    mergedMap[key].properties.total_amount += props.total_amount;
                    mergedMap[key].properties.visit_count += props.visit_count;
                }
            });

            return Object.values(mergedMap);
        }

        function setYear(year, btn) {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let rawPoints = [];
            if (year === 'all') {
                rawPoints = [...mapDataMap['2023'], ...mapDataMap['2024'], ...mapDataMap['2025']];
            } else {
                rawPoints = mapDataMap[year] || [];
            }

            // [ì¤‘ìš”] ì—¬ê¸°ì„œ 'ë°©ë¬¸ ê¸°ë¡' ìˆ˜ì²œ ê°œê°€ -> 'ì‹ë‹¹' ìˆ˜ë°± ê°œë¡œ ì¤„ì–´ë“­ë‹ˆë‹¤.
            const aggregatedPoints = aggregateData(rawPoints);
            
            index.load(aggregatedPoints);
            updateMap();
        }

        // 4. ì§€ë„ ê·¸ë¦¬ê¸°
        function updateMap() {
            const bounds = map.getBounds();
            const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
            const zoom = map.getZoom();

            const clusters = index.getClusters(bbox, zoom);
            markersLayer.clearLayers();

            clusters.forEach(feature => {
                const [lng, lat] = feature.geometry.coordinates;
                const isCluster = feature.properties.cluster;

                if (isCluster) {
                    // ========================================================
                    // ğŸ“Œ í•µì‹¬ ìˆ˜ì •: í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ì˜ ìˆ«ìëŠ” ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ê°€?
                    // ========================================================
                    // feature.properties.point_count : ì´ í´ëŸ¬ìŠ¤í„° ì•ˆì— ìˆëŠ” 'Point(ì‹ë‹¹)'ì˜ ê°œìˆ˜
                    // feature.properties.sumVisits   : ì´ í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ì¼ì–´ë‚œ 'ì´ ë°©ë¬¸ íšŸìˆ˜' (reduceë¡œ ê³„ì‚°ë¨)
                    
                    const restaurantCount = feature.properties.point_count; 
                    
                    let sizeClass = restaurantCount > 100 ? 'large' : (restaurantCount > 50 ? 'medium' : '');
                    let size = restaurantCount > 100 ? 55 : (restaurantCount > 50 ? 45 : 35);

                    const icon = L.divIcon({
                        html: `<div class="cluster-marker ${sizeClass}" style="width:${size}px; height:${size}px;">${shortenNum(restaurantCount)}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: [size, size]
                    });

                    const marker = L.marker([lat, lng], { icon: icon });

                    marker.on('click', () => {
                        const expansionZoom = index.getClusterExpansionZoom(feature.properties.cluster_id);
                        if (expansionZoom > 19 || zoom >= 18) {
                            showClusterPopup(feature, lat, lng);
                        } else {
                            map.setView([lat, lng], expansionZoom);
                        }
                    });
                    markersLayer.addLayer(marker);

                } else {
                    // ê°œë³„ ì‹ë‹¹ ë§ˆì»¤
                    const props = feature.properties;
                    const marker = L.marker([lat, lng]);
                    const avgPrice = props.visit_count > 0 ? Math.round(props.total_amount / props.visit_count) : 0;

                    const popupContent = `
                        <div style="text-align:center; min-width:180px;">
                            <h3 style="margin:0 0 5px; color:#212529; font-size:16px;">${props.name}</h3>
                            <p style="margin:0 0 10px; color:#868e96; font-size:12px;">${props.address}</p>
                            <div style="background:#f8f9fa; padding:10px; border-radius:8px; text-align:left;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                    <span style="color:#495057;">ğŸ’° ì´ ì‚¬ìš©ì•¡</span>
                                    <span style="font-weight:bold; color:#212529;">${props.total_amount.toLocaleString()}ì›</span>
                                </div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="color:#495057;">ğŸš© ë°©ë¬¸íšŸìˆ˜</span>
                                    <span style="font-weight:bold; color:#212529;">${props.visit_count}íšŒ</span>
                                </div>
                                <hr style="margin:8px 0; border-top:1px dashed #ced4da;">
                                <div style="text-align:right; font-size:12px; color:#fa5252;">
                                    1íšŒ í‰ê· : <b>${avgPrice.toLocaleString()}ì›</b>
                                </div>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                }
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function moveToCurrentLocation() { map.locate({setView: true, maxZoom: 16}); }
        map.on('locationfound', e => {
            gpsLayer.clearLayers();
            L.circle(e.latlng, { radius: e.accuracy / 2, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.1 }).addTo(gpsLayer);
            L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1 }).addTo(gpsLayer);
        });

        function shortenNum(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        // íŒì—… í‘œì‹œ (ì—¬ê¸°ì„œëŠ” í•©ê³„ ê¸ˆì•¡ê³¼ í•©ê³„ ë°©ë¬¸íšŸìˆ˜ë¥¼ ë³´ì—¬ì¤Œ)
        function showClusterPopup(clusterFeature, lat, lng) {
            // reduceë¡œ ê³„ì‚°ëœ ì†ì„± ì‚¬ìš©
            const totalMoney = clusterFeature.properties.sumMoney;
            const totalVisits = clusterFeature.properties.sumVisits;
            const restaurantCount = clusterFeature.properties.point_count;

            // ìƒìœ„ ì‹ë‹¹ ì •ë³´ëŠ” getLeavesë¡œ ê°€ì ¸ì˜´
            const leaves = index.getLeaves(clusterFeature.properties.cluster_id, Infinity);
            const topList = leaves
                .sort((a,b) => b.properties.visit_count - a.properties.visit_count)
                .slice(0, 3)
                .map(leaf => `<li style="margin-bottom:3px;">${leaf.properties.name} <span style="color:gray; font-size:11px;">(${leaf.properties.visit_count}íšŒ)</span></li>`)
                .join('');

            const content = `
                <div style="min-width:200px;">
                    <h3 style="margin:0 0 10px; font-size:15px;">ğŸ¢ ë°€ì§‘ ì§€ì—­ (${restaurantCount}ê³³)</h3>
                    <div style="background:#e9ecef; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <b>ì´ ê¸ˆì•¡:</b> ${totalMoney.toLocaleString()}ì›<br>
                        <b>ì´ ë°©ë¬¸:</b> ${totalVisits.toLocaleString()}íšŒ
                    </div>
                    <p style="margin:5px 0; font-weight:bold; font-size:12px;">ğŸ”¥ ì£¼ìš” ì‹ë‹¹:</p>
                    <ul style="padding-left:20px; margin:0; font-size:12px;">${topList}</ul>
                </div>
            `;
            L.popup().setLatLng([lat, lng]).setContent(content).openOn(map);
        }

        async function clearCache() {
            if(confirm('ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await localforage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
