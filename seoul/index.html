<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ë§›ì§‘ ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }
        
        /* ìƒë‹¨ ì—°ë„ ì„ íƒ ë²„íŠ¼ */
        .year-controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            gap: 8px;
            white-space: nowrap;
        }

        .year-btn {
            border: none;
            background: #f0f0f0;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: 0.2s;
        }

        .year-btn:hover { background: #e0e0e0; }
        .year-btn.active { background: #007bff; color: white; }

        /* ìš°ì¸¡ í•˜ë‹¨ ë‚´ ìœ„ì¹˜ ë²„íŠ¼ */
        .gps-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 20px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .gps-btn:hover { background: #f8f9fa; color: #007bff; }
        .gps-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <div class="year-controls">
        <button class="year-btn active" onclick="showYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="showYear('2025', this)">2025</button>
        <button class="year-btn" onclick="showYear('2024', this)">2024</button>
        <button class="year-btn" onclick="showYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()" title="í˜„ìœ„ì¹˜ë¡œ ì´ë™">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // 1. ì§€ë„ ì´ˆê¸°í™” (ê¸°ë³¸: ì„œìš¸ì‹œì²­)
        var map = L.map('map').setView([37.5665, 126.9780], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // 2. í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì„¤ì • (ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ëœ ë­‰ì¹˜ê²Œ ì„¤ì •)
        var markersLayer = L.markerClusterGroup({
            chunkedLoading: true,        // ë²„ë²…ì„ ë°©ì§€
            maxClusterRadius: 35,        // ìˆ«ìê°€ ì‘ì„ìˆ˜ë¡ ëœ ë­‰ì¹¨ (ê¸°ë³¸ê°’ 80)
            disableClusteringAtZoom: 16, // 16ë ˆë²¨ ì´ìƒ í™•ëŒ€í•˜ë©´ í´ëŸ¬ìŠ¤í„° í•´ì œ (í•€ ë‹¤ ë³´ì—¬ì¤Œ)
            spiderfyOnMaxZoom: true      // ê°™ì€ ìœ„ì¹˜ í•€ì€ í´ë¦­ ì‹œ í¼ì§€ê²Œ
        });
        
        map.addLayer(markersLayer);
        
        var mapData = { '2023': [], '2024': [], '2025': [] };

        // 3. ì‹œì‘í•˜ìë§ˆì ë‚´ ìœ„ì¹˜ ì°¾ê¸° ì‹œë„
        map.locate({setView: true, maxZoom: 15});
        
        // ìœ„ì¹˜ ì°¾ê¸° ì„±ê³µ ì‹œ
        map.on('locationfound', function(e) {
            // íŒŒë€ìƒ‰ ì›ìœ¼ë¡œ ë‚´ ìœ„ì¹˜ í‘œì‹œ
            L.circle(e.latlng, {
                radius: e.accuracy / 2,
                color: '#4285F4',
                fillColor: '#4285F4',
                fillOpacity: 0.2
            }).addTo(map);
            L.circleMarker(e.latlng, {
                radius: 8,
                color: '#fff',
                fillColor: '#4285F4',
                fillOpacity: 1
            }).addTo(map);
        });

        // ìœ„ì¹˜ ì°¾ê¸° ì‹¤íŒ¨ ì‹œ (ê¶Œí•œ ê±°ë¶€ ë“±) - ê·¸ëƒ¥ ì„œìš¸ì‹œì²­ ìœ ì§€
        map.on('locationerror', function(e) {
            console.log("ìœ„ì¹˜ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });


        // 4. ë°ì´í„° ë¡œë“œ
        Promise.all([
            fetch('./map_data_2023.json').then(res => res.ok ? res.json() : []),
            fetch('./map_data_2024.json').then(res => res.ok ? res.json() : []),
            fetch('./map_data_2025.json').then(res => res.ok ? res.json() : [])
        ]).then(results => {
            mapData['2023'] = results[0];
            mapData['2024'] = results[1];
            mapData['2025'] = results[2];
            showYear('all', document.querySelector('.year-btn.active'));
        }).catch(err => alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨"));


        // 5. ì§€ë„ ë Œë”ë§ í•¨ìˆ˜
        function renderMap(dataList) {
            markersLayer.clearLayers();
            var newMarkers = [];

            dataList.forEach(item => {
                if (item.lat && item.lng) {
                    var marker = L.marker([item.lat, item.lng]);
                    
                    // íšŒë‹¹ í‰ê·  ê¸ˆì•¡ ê³„ì‚°
                    var avgPrice = Math.round(item.total_amount / item.visit_count);

                    var popupContent = `
                        <div style="text-align:center; min-width:160px; font-size:13px;">
                            <h3 style="margin:0 0 5px; color:#007bff; font-size:15px;">${item.name}</h3>
                            <p style="margin:0 0 8px; color:#666; font-size:11px;">${item.address}</p>
                            <div style="background:#f8f9fa; padding:8px; border-radius:5px; text-align:left;">
                                <p style="margin:3px 0;">ğŸ’° <b>ì´ ì§‘í–‰ê¸ˆì•¡:</b> ${item.total_amount.toLocaleString()}ì›</p>
                                <p style="margin:3px 0;">ğŸš© <b>ì´ ë°©ë¬¸íšŸìˆ˜:</b> ${item.visit_count}íšŒ</p>
                                <hr style="border:0; border-top:1px dashed #ccc; margin:5px 0;">
                                <p style="margin:3px 0; color:#d63384;">ğŸ’³ <b>1íšŒ í‰ê· :</b> ${avgPrice.toLocaleString()}ì›</p>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    newMarkers.push(marker);
                }
            });
            markersLayer.addLayers(newMarkers);
        }

        // 6. ì—°ë„ í•„í„°ë§
        function showYear(year, btnElement) {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            if (year === 'all') {
                var mergedData = {};
                ['2023', '2024', '2025'].forEach(y => {
                    mapData[y].forEach(item => {
                        var key = item.name + "|" + item.address;
                        if (!mergedData[key]) {
                            mergedData[key] = { ...item }; 
                        } else {
                            mergedData[key].total_amount += item.total_amount;
                            mergedData[key].visit_count += item.visit_count;
                        }
                    });
                });
                renderMap(Object.values(mergedData));
            } else {
                renderMap(mapData[year]);
            }
        }

        // 7. í˜„ìœ„ì¹˜ ë²„íŠ¼ ê¸°ëŠ¥
        function moveToCurrentLocation() {
            map.locate({setView: true, maxZoom: 16});
        }
    </script>
</body>
</html>
