<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ì§€ë„</title>

	<link rel="icon" type="image/png" sizes="16x16" href="/seoul/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/seoul/favicon-32x32.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/seoul/apple-touch-icon.png">
	<link rel="manifest" href="/seoul/site.webmanifest">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="seoul Meter">
	<link rel="apple-touch-icon" sizes="180x180" href="/seoul/apple-touch-icon.png">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        #map { width: 100%; height: 100vh; z-index: 1; background: #f0f0f0; }
        
        /* ì»¤ìŠ¤í…€ í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ */
        .custom-cluster-icon {
            background: rgba(66, 133, 244, 0.9);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .custom-cluster-icon.medium { background: #fb8c00; }
        .custom-cluster-icon.large { background: #e53935; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .year-controls {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 6px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; gap: 5px; white-space: nowrap;
        }
        .year-btn {
            border: none; background: transparent; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px;
            color: #555; transition: 0.2s;
        }
        .year-btn:hover { background: #f1f1f1; }
        .year-btn.active { background: #212529; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 22px; color: #333;
            display: flex; align-items: center; justify-content: center;
        }
        .reset-btn {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: white; border: 1px solid #ddd;
            padding: 6px 10px; font-size: 11px; border-radius: 8px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #666;
			display: none;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: rgba(0,0,0,0.8); color: white;
            padding: 20px 30px; border-radius: 12px; font-size: 15px; display: none;
            backdrop-filter: blur(2px);
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>
    
    <button class="reset-btn" onclick="clearCache()">
        <i class="fa-solid fa-rotate-right"></i> ë°ì´í„° ê°±ì‹ 
    </button>

    <div class="year-controls">
        <button class="year-btn active" onclick="setYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="setYear('2025', this)">2025</button>
        <button class="year-btn" onclick="setYear('2024', this)">2024</button>
        <button class="year-btn" onclick="setYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <script>
        // 1. ì„¤ì •
        localforage.config({ name: 'SeoulFoodMap', storeName: 'map_data_v6' });
        
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5216, 126.9241], 14);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        const gpsLayer = L.layerGroup().addTo(map);

        const markersLayer = L.markerClusterGroup({
            chunkedLoading: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            maxClusterRadius: 50,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                let c = ' custom-cluster-icon';
                let size = 40;
                if (count > 100) { c += ' large'; size = 55; }
                else if (count > 50) { c += ' medium'; size = 45; }
                return new L.DivIcon({
                    html: `<div>${shortenNum(count)}</div>`,
                    className: c,
                    iconSize: [size, size]
                });
            }
        });
        map.addLayer(markersLayer);

        let mapDataMap = {};

        // 2. ë°ì´í„° ë¡œë“œ ë° ìºì‹±
        async function loadDataWithCache(year) {
            const cacheKey = `geo_data_${year}_v2`; 
            const loadingEl = document.getElementById('loading');
            try {
                const cached = await localforage.getItem(cacheKey);
                if (cached) return cached;
                
                loadingEl.style.display = 'block';
                const res = await fetch(`./map_data_${year}.json`);
                if (!res.ok) throw new Error('File not found');
                const json = await res.json();

                const geoJsonPoints = json
                    .filter(item => item.lat && item.lng)
                    .map(item => ({
                        name: item.name,
                        address: item.address,
                        total_amount: item.total_amount,
                        visit_count: item.visit_count,
                        lat: item.lat,
                        lng: item.lng
                    }));

                await localforage.setItem(cacheKey, geoJsonPoints);
                return geoJsonPoints;
            } catch (err) {
                console.error(err);
                return [];
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        (async function init() {
            const results = await Promise.all([
                loadDataWithCache('2023'),
                loadDataWithCache('2024'),
                loadDataWithCache('2025')
            ]);
            mapDataMap['2023'] = results[0];
            mapDataMap['2024'] = results[1];
            mapDataMap['2025'] = results[2];
            setYear('all', document.querySelector('.year-btn.active'));
        })();


        // 3. ë°ì´í„° ë³‘í•© (ì¢Œí‘œ ê¸°ì¤€ Aggregation) - í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ â­
        function aggregateData(points) {
            const mergedMap = {};

            points.forEach(pt => {
                // (1) ìƒí˜¸ëª… ì •ê·œí™”: (ì£¼), ê³µë°± ì œê±° (ì˜ˆ: 'ìŠ¤íƒ€ ë²…ìŠ¤' == 'ìŠ¤íƒ€ë²…ìŠ¤')
                const cleanName = pt.name.replace(/\(ì£¼\)/g, '').replace(/\s+/g, '').trim();
                
                // (2) ì¢Œí‘œ ì •ë°€ë„ ì¡°ì • (ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ë°©ì§€ìœ„í•´ 7ì§¸ìë¦¬ê¹Œì§€ ëŠìŒ)
                // ìœ„ë„/ê²½ë„ê°€ ê°™ìœ¼ë©´ ê°™ì€ ì¥ì†Œë¡œ ì¸ì‹! (ì£¼ì†Œ í…ìŠ¤íŠ¸ëŠ” ë¬´ì‹œ)
                const latKey = parseFloat(pt.lat).toFixed(7);
                const lngKey = parseFloat(pt.lng).toFixed(7);

                // ê³ ìœ  í‚¤ ìƒì„±: ì´ë¦„ + ì¢Œí‘œ
                const key = `${cleanName}|${latKey}|${lngKey}`; 

                if (!mergedMap[key]) {
                    // ìµœì´ˆ ë“±ë¡ ì‹œ
                    mergedMap[key] = { 
                        ...pt, 
                        name: pt.name // í™”ë©´ì—ëŠ” ì›ë³¸ ìƒí˜¸ëª… í‘œì‹œ
                    }; 
                } else {
                    // ì¤‘ë³µ ì‹œ ê¸ˆì•¡/íšŸìˆ˜ ëˆ„ì 
                    mergedMap[key].total_amount += pt.total_amount;
                    mergedMap[key].visit_count += pt.visit_count;
                }
            });

            return Object.values(mergedMap);
        }


        // 4. ë Œë”ë§
        function setYear(year, btn) {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let rawPoints = [];
            if (year === 'all') {
                rawPoints = [...mapDataMap['2023'], ...mapDataMap['2024'], ...mapDataMap['2025']];
            } else {
                rawPoints = mapDataMap[year] || [];
            }

            const aggregatedPoints = aggregateData(rawPoints);
            renderMarkers(aggregatedPoints);
        }

        function renderMarkers(points) {
            markersLayer.clearLayers();
            const markers = [];

            points.forEach(pt => {
                const avgPrice = pt.visit_count > 0 ? Math.round(pt.total_amount / pt.visit_count) : 0;
                
                const marker = L.marker([pt.lat, pt.lng]);
                
                const popupContent = `
                    <div style="text-align:center; min-width:180px;">
                        <h3 style="margin:0 0 5px; color:#212529; font-size:16px;">${pt.name}</h3>
                        <p style="margin:0 0 10px; color:#868e96; font-size:12px;">${pt.address}</p>
                        <div style="background:#f8f9fa; padding:10px; border-radius:8px; text-align:left;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="color:#495057;">ğŸ’° ì´ ì‚¬ìš©ì•¡</span>
                                <span style="font-weight:bold; color:#212529;">${pt.total_amount.toLocaleString()}ì›</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:#495057;">ğŸš© ë°©ë¬¸íšŸìˆ˜</span>
                                <span style="font-weight:bold; color:#212529;">${pt.visit_count}íšŒ</span>
                            </div>
                            <hr style="margin:8px 0; border-top:1px dashed #ced4da;">
                            <div style="text-align:right; font-size:12px; color:#fa5252;">
                                1íšŒ í‰ê· : <b>${avgPrice.toLocaleString()}ì›</b>
                            </div>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markers.push(marker);
            });
            markersLayer.addLayers(markers);
        }

        // ìœ í‹¸ë¦¬í‹°
        function moveToCurrentLocation() { map.locate({setView: true, maxZoom: 16}); }
        map.on('locationfound', e => {
            gpsLayer.clearLayers();
            L.circle(e.latlng, { radius: e.accuracy / 2, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.1 }).addTo(gpsLayer);
            L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1 }).addTo(gpsLayer);
        });

        function shortenNum(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        async function clearCache() {
            if(confirm('ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await localforage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
