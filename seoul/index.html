<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ë§›ì§‘ ì§€ë„ (ì—°ë„ë³„)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }
        
        /* ë²„íŠ¼ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .year-controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000; /* ì§€ë„ ìœ„ì— ë– ìˆì–´ì•¼ í•¨ */
            background: white;
            padding: 10px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
        }

        .year-btn {
            border: none;
            background: #f0f0f0;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.2s;
        }

        .year-btn:hover {
            background: #e0e0e0;
        }

        /* ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .year-btn.active {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>

    <div class="year-controls">
        <button class="year-btn active" onclick="showYear('all', this)">ì „ì²´(í•©ê³„)</button>
        <button class="year-btn" onclick="showYear('2025', this)">2025ë…„</button>
        <button class="year-btn" onclick="showYear('2024', this)">2024ë…„</button>
        <button class="year-btn" onclick="showYear('2023', this)">2023ë…„</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. ì§€ë„ ì´ˆê¸°í™”
        var map = L.map('map').setView([37.5665, 126.9780], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var markersLayer = L.layerGroup().addTo(map); // ë§ˆì»¤ë“¤ì„ ë‹´ì„ ê·¸ë£¹
        
        // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„°ë¥¼ ì €ì¥í•´ë‘ 
        var mapData = {
            '2023': [],
            '2024': [],
            '2025': []
        };

        // 2. ëª¨ë“  JSON íŒŒì¼ í•œ ë²ˆì— ë¡œë“œí•˜ê¸°
        Promise.all([
            fetch('./map_data_2023.json').then(res => res.ok ? res.json() : []),
            fetch('./map_data_2024.json').then(res => res.ok ? res.json() : []),
            fetch('./map_data_2025.json').then(res => res.ok ? res.json() : [])
        ]).then(results => {
            mapData['2023'] = results[0];
            mapData['2024'] = results[1];
            mapData['2025'] = results[2];

            console.log("ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", mapData);
            
            // ì²˜ìŒì—ëŠ” 'ì „ì²´' ë°ì´í„°ë¥¼ ë³´ì—¬ì¤Œ
            showYear('all', document.querySelector('.year-btn.active'));
        }).catch(err => {
            console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
            alert("JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ëª…ì´ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
        });


        // 3. ì§€ë„ì— ë§ˆì»¤ ì°ëŠ” í•¨ìˆ˜ (ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ ì‹¤í–‰)
        function renderMap(dataList) {
            markersLayer.clearLayers(); // ê¸°ì¡´ ë§ˆì»¤ ì§€ìš°ê¸°

            dataList.forEach(item => {
                var marker = L.marker([item.lat, item.lng]);
                
                var popupContent = `
                    <div style="text-align:center; min-width:150px;">
                        <h3 style="margin:0 0 5px; color:#007bff;">${item.name}</h3>
                        <p style="margin:0; font-size:12px; color:gray;">${item.address}</p>
                        <hr style="margin:8px 0; border:0; border-top:1px solid #eee;">
                        <p style="margin:5px 0;"><b>ğŸ’° ì´ ê¸ˆì•¡:</b> ${item.total_amount.toLocaleString()}ì›</p>
                        <p style="margin:5px 0;"><b>ğŸš© ë°©ë¬¸ íšŸìˆ˜:</b> ${item.visit_count}íšŒ</p>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markersLayer.addLayer(marker);
            });
        }


        // 4. ì—°ë„ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        function showYear(year, btnElement) {
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            if (year === 'all') {
                // [ì „ì²´ ë³´ê¸° ë¡œì§] : 2023, 2024, 2025 ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì¹¨ (Aggregation)
                var mergedData = {};

                ['2023', '2024', '2025'].forEach(y => {
                    mapData[y].forEach(item => {
                        // ì‹ë‹¹ ì´ë¦„ê³¼ ì£¼ì†Œë¥¼ í‚¤(Key)ë¡œ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ í™•ì¸
                        var key = item.name + "|" + item.address;

                        if (!mergedData[key]) {
                            // ì²˜ìŒ ë°œê²¬ëœ ì‹ë‹¹ì´ë©´ ë³µì‚¬í•´ì„œ ë“±ë¡
                            mergedData[key] = { ...item }; 
                        } else {
                            // ì´ë¯¸ ìˆëŠ” ì‹ë‹¹ì´ë©´ ê¸ˆì•¡ê³¼ íšŸìˆ˜ë§Œ ë”í•¨
                            mergedData[key].total_amount += item.total_amount;
                            mergedData[key].visit_count += item.visit_count;
                        }
                    });
                });
                
                // í•©ì³ì§„ ê°ì²´(Dictionary)ë¥¼ ë‹¤ì‹œ ë¦¬ìŠ¤íŠ¸(Array)ë¡œ ë³€í™˜
                renderMap(Object.values(mergedData));

            } else {
                // [íŠ¹ì • ì—°ë„ ë³´ê¸° ë¡œì§]
                renderMap(mapData[year]);
            }
        }
    </script>
</body>
</html>