<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ë§›ì§‘ ì§€ë„ (Spiderfy)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        #map { width: 100%; height: 100vh; z-index: 1; background: #f0f0f0; }
        
        /* ì»¤ìŠ¤í…€ í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .custom-cluster-icon {
            background: rgba(66, 133, 244, 0.9);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 40px; /* ë†’ì´ì™€ ë§ì¶°ì•¼ ìˆ˜ì§ì •ë ¬ ë¨ */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .custom-cluster-icon.medium { background: #fb8c00; } /* 50ê°œ ì´ìƒ */
        .custom-cluster-icon.large { background: #e53935; }  /* 100ê°œ ì´ìƒ */

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ë“¤ */
        .year-controls {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 6px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; gap: 5px; white-space: nowrap;
        }
        .year-btn {
            border: none; background: transparent; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px;
            color: #555; transition: 0.2s;
        }
        .year-btn:hover { background: #f1f1f1; }
        .year-btn.active { background: #212529; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 22px; color: #333;
            display: flex; align-items: center; justify-content: center;
        }
        .reset-btn {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: white; border: 1px solid #ddd;
            padding: 6px 10px; font-size: 11px; border-radius: 8px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #666;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: rgba(0,0,0,0.8); color: white;
            padding: 20px 30px; border-radius: 12px; font-size: 15px; display: none;
            backdrop-filter: blur(2px);
        }
        .leaflet-popup-content-wrapper { border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>
    
    <button class="reset-btn" onclick="clearCache()">
        <i class="fa-solid fa-rotate-right"></i> ë°ì´í„° ê°±ì‹ 
    </button>

    <div class="year-controls">
        <button class="year-btn active" onclick="setYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="setYear('2025', this)">2025</button>
        <button class="year-btn" onclick="setYear('2024', this)">2024</button>
        <button class="year-btn" onclick="setYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

    <script>
        // 1. ì„¤ì •
        localforage.config({ name: 'SeoulFoodMap', storeName: 'map_data_v5' });
        
        const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 14);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        const gpsLayer = L.layerGroup().addTo(map);

        // ============================================================
        // ğŸš€ MarkerClusterGroup ì„¤ì • (í¼ì¹˜ê¸° ê¸°ëŠ¥ ë¶€í™œì˜ í•µì‹¬)
        // ============================================================
        const markersLayer = L.markerClusterGroup({
            chunkedLoading: true,        // ëŒ€ëŸ‰ ë°ì´í„° ë²„ë²…ì„ ë°©ì§€
            spiderfyOnMaxZoom: true,     // â­ í•µì‹¬: ê²¹ì¹œ ë§ˆì»¤ í´ë¦­ ì‹œ í¼ì³ì§€ê¸°
            showCoverageOnHover: false,  // ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë²”ìœ„ í´ë¦¬ê³¤ ë„ê¸° (ê¹”ë”í•˜ê²Œ)
            maxClusterRadius: 50,        // í´ëŸ¬ìŠ¤í„° ë­‰ì¹˜ëŠ” ë°˜ê²½ (ì ë‹¹íˆ)
            
            // í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ ì»¤ìŠ¤í…€ (ìƒ‰ìƒ/í¬ê¸°)
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                let c = ' custom-cluster-icon';
                let size = 40;

                if (count > 100) { c += ' large'; size = 55; }
                else if (count > 50) { c += ' medium'; size = 45; }

                return new L.DivIcon({
                    html: `<div>${shortenNum(count)}</div>`,
                    className: c,
                    iconSize: [size, size]
                });
            }
        });
        map.addLayer(markersLayer);


        let mapDataMap = {};

        // 2. ë°ì´í„° ë¡œë“œ ë° ìºì‹±
        async function loadDataWithCache(year) {
            const cacheKey = `geo_data_${year}_v2`; 
            const loadingEl = document.getElementById('loading');
            
            try {
                const cached = await localforage.getItem(cacheKey);
                if (cached) return cached;

                loadingEl.style.display = 'block';
                const res = await fetch(`./map_data_${year}.json`);
                if (!res.ok) throw new Error('File not found');
                const json = await res.json();

                // GeoJSON ë³€í™˜
                const geoJsonPoints = json
                    .filter(item => item.lat && item.lng)
                    .map(item => ({
                        name: item.name,
                        address: item.address,
                        total_amount: item.total_amount,
                        visit_count: item.visit_count,
                        lat: item.lat,
                        lng: item.lng
                    }));

                await localforage.setItem(cacheKey, geoJsonPoints);
                return geoJsonPoints;

            } catch (err) {
                console.error(err);
                return [];
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        (async function init() {
            const results = await Promise.all([
                loadDataWithCache('2023'),
                loadDataWithCache('2024'),
                loadDataWithCache('2025')
            ]);
            mapDataMap['2023'] = results[0];
            mapDataMap['2024'] = results[1];
            mapDataMap['2025'] = results[2];
            setYear('all', document.querySelector('.year-btn.active'));
        })();


        // 3. ë°ì´í„° ë³‘í•© (Aggregation)
        function aggregateData(points) {
            const mergedMap = {};

            points.forEach(pt => {
                // ì´ë¦„ ì •ê·œí™”
                const cleanName = pt.name.replace(/\(ì£¼\)/g, '').trim(); 
                const key = `${cleanName}|${pt.address}`; 

                if (!mergedMap[key]) {
                    mergedMap[key] = { ...pt, name: cleanName }; // ë³µì‚¬
                } else {
                    mergedMap[key].total_amount += pt.total_amount;
                    mergedMap[key].visit_count += pt.visit_count;
                }
            });

            return Object.values(mergedMap);
        }

        // 4. ì§€ë„ ê·¸ë¦¬ê¸°
        function setYear(year, btn) {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let rawPoints = [];
            if (year === 'all') {
                rawPoints = [...mapDataMap['2023'], ...mapDataMap['2024'], ...mapDataMap['2025']];
            } else {
                rawPoints = mapDataMap[year] || [];
            }

            // ë³‘í•© ì‹¤í–‰ (ì‹ë‹¹ ë‹¨ìœ„ë¡œ ë³€í™˜)
            const aggregatedPoints = aggregateData(rawPoints);
            
            // ë§ˆì»¤ ìƒì„± ë° í´ëŸ¬ìŠ¤í„° ì¶”ê°€
            renderMarkers(aggregatedPoints);
        }

        function renderMarkers(points) {
            markersLayer.clearLayers(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
            const markers = [];

            points.forEach(pt => {
                const avgPrice = pt.visit_count > 0 ? Math.round(pt.total_amount / pt.visit_count) : 0;
                
                const marker = L.marker([pt.lat, pt.lng]);
                
                const popupContent = `
                    <div style="text-align:center; min-width:180px;">
                        <h3 style="margin:0 0 5px; color:#212529; font-size:16px;">${pt.name}</h3>
                        <p style="margin:0 0 10px; color:#868e96; font-size:12px;">${pt.address}</p>
                        <div style="background:#f8f9fa; padding:10px; border-radius:8px; text-align:left;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="color:#495057;">ğŸ’° ì´ ì‚¬ìš©ì•¡</span>
                                <span style="font-weight:bold; color:#212529;">${pt.total_amount.toLocaleString()}ì›</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:#495057;">ğŸš© ë°©ë¬¸íšŸìˆ˜</span>
                                <span style="font-weight:bold; color:#212529;">${pt.visit_count}íšŒ</span>
                            </div>
                            <hr style="margin:8px 0; border-top:1px dashed #ced4da;">
                            <div style="text-align:right; font-size:12px; color:#fa5252;">
                                1íšŒ í‰ê· : <b>${avgPrice.toLocaleString()}ì›</b>
                            </div>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            // í•œ ë²ˆì— ì¶”ê°€ (ì„±ëŠ¥ í–¥ìƒ)
            markersLayer.addLayers(markers);
        }

        // ìœ í‹¸ë¦¬í‹°
        function moveToCurrentLocation() { map.locate({setView: true, maxZoom: 16}); }
        map.on('locationfound', e => {
            gpsLayer.clearLayers();
            L.circle(e.latlng, { radius: e.accuracy / 2, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.1 }).addTo(gpsLayer);
            L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1 }).addTo(gpsLayer);
        });

        function shortenNum(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        async function clearCache() {
            if(confirm('ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await localforage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
