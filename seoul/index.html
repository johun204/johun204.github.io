<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ë§›ì§‘ ì§€ë„</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        #map { width: 100%; height: 100vh; z-index: 1; }
        
        .year-controls {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 8px; border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; gap: 8px; white-space: nowrap;
        }
        .year-btn {
            border: none; background: #f0f0f0; padding: 8px 14px;
            border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 13px;
        }
        .year-btn.active { background: #007bff; color: white; }

        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 45px; height: 45px; border-radius: 50%;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; font-size: 20px; color: #333;
        }
        
        /* ë°ì´í„° ë¦¬ì…‹ ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ì‘ê²Œ) */
        .reset-btn {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: rgba(255,255,255,0.8); border: 1px solid #ccc;
            padding: 5px 8px; font-size: 10px; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

    <button class="reset-btn" onclick="clearCache()">ğŸ”„ ë°ì´í„° ê°±ì‹ </button>

    <div class="year-controls">
        <button class="year-btn active" onclick="showYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="showYear('2025', this)">2025</button>
        <button class="year-btn" onclick="showYear('2024', this)">2024</button>
        <button class="year-btn" onclick="showYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()"><i class="fa-solid fa-location-crosshairs"></i></button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        var map = L.map('map').setView([37.5665, 126.9780], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        var markersLayer = L.markerClusterGroup({
            chunkedLoading: true, maxClusterRadius: 35,
            disableClusteringAtZoom: 16, spiderfyOnMaxZoom: true
        });
        map.addLayer(markersLayer);

        // í˜„ìœ„ì¹˜ ê¸°ëŠ¥
        map.locate({setView: true, maxZoom: 15});
        map.on('locationfound', function(e) {
            L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1 }).addTo(map);
        });

        // ==========================================
        // ğŸš€ í•µì‹¬: ìŠ¤ë§ˆíŠ¸ ìºì‹± ë¡œë”© í•¨ìˆ˜
        // ==========================================
        async function loadDataWithCache(year) {
            const cacheKey = `cached_map_data_${year}`;
            
            // 1. ë¡œì»¬ ì €ì¥ì†Œ í™•ì¸
            const cachedData = localStorage.getItem(cacheKey);
            
            if (cachedData) {
                console.log(`[Cache Hit] ${year}ë…„ ë°ì´í„° í°ì—ì„œ ë¡œë“œë¨`);
                return JSON.parse(cachedData); // ë‹¤ìš´ë¡œë“œ ì—†ì´ ë°”ë¡œ ë°˜í™˜
            }

            // 2. ì—†ìœ¼ë©´ ë‹¤ìš´ë¡œë“œ ìˆ˜í–‰
            console.log(`[Network] ${year}ë…„ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...`);
            try {
                const response = await fetch(`./map_data_${year}.json`);
                if (!response.ok) return []; // íŒŒì¼ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
                
                const json = await response.json();

                // 3. ë‹¤ìš´ë°›ì€ ë°ì´í„°ë¥¼ í°ì— ì €ì¥ (ë¬¸ìì—´ë¡œ ë³€í™˜)
                try {
                    localStorage.setItem(cacheKey, JSON.stringify(json));
                } catch (e) {
                    console.warn("ì €ì¥ ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ ìºì‹± ì‹¤íŒ¨ (ê¸°ëŠ¥ì—” ë¬¸ì œì—†ìŒ)");
                }

                return json;
            } catch (err) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                return [];
            }
        }

        // ==========================================
        
        var mapData = { '2023': [], '2024': [], '2025': [] };

        // Promise.allë¡œ ë³‘ë ¬ ë¡œë”©í•˜ë˜, ìœ„ì—ì„œ ë§Œë“  ìŠ¤ë§ˆíŠ¸ í•¨ìˆ˜ ì‚¬ìš©
        Promise.all([
            loadDataWithCache('2023'),
            loadDataWithCache('2024'),
            loadDataWithCache('2025')
        ]).then(results => {
            mapData['2023'] = results[0];
            mapData['2024'] = results[1];
            mapData['2025'] = results[2];
            showYear('all', document.querySelector('.year-btn.active'));
        });

        function renderMap(dataList) {
            markersLayer.clearLayers();
            var newMarkers = [];
            dataList.forEach(item => {
                if (item.lat && item.lng) {
                    var avgPrice = item.visit_count > 0 ? Math.round(item.total_amount / item.visit_count) : 0;
                    var marker = L.marker([item.lat, item.lng]);
                    var popupContent = `
                        <div style="text-align:center; min-width:160px; font-size:13px;">
                            <h3 style="margin:0 0 5px; color:#007bff; font-size:15px;">${item.name}</h3>
                            <p style="margin:0 0 8px; color:#666; font-size:11px;">${item.address}</p>
                            <div style="background:#f8f9fa; padding:8px; border-radius:5px; text-align:left;">
                                <p style="margin:3px 0;">ğŸ’° <b>ì´ ì§‘í–‰ê¸ˆì•¡:</b> ${item.total_amount.toLocaleString()}ì›</p>
                                <p style="margin:3px 0;">ğŸš© <b>ì´ ë°©ë¬¸íšŸìˆ˜:</b> ${item.visit_count}íšŒ</p>
                                <hr style="border:0; border-top:1px dashed #ccc; margin:5px 0;">
                                <p style="margin:3px 0; color:#d63384;">ğŸ’³ <b>1íšŒ í‰ê· :</b> ${avgPrice.toLocaleString()}ì›</p>
                            </div>
                        </div>`;
                    marker.bindPopup(popupContent);
                    newMarkers.push(marker);
                }
            });
            markersLayer.addLayers(newMarkers);
        }

        function showYear(year, btnElement) {
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            if (year === 'all') {
                var mergedData = {};
                ['2023', '2024', '2025'].forEach(y => {
                    mapData[y].forEach(item => {
                        var key = item.name + "|" + item.address;
                        if (!mergedData[key]) {
                            mergedData[key] = { ...item }; 
                        } else {
                            mergedData[key].total_amount += item.total_amount;
                            mergedData[key].visit_count += item.visit_count;
                        }
                    });
                });
                renderMap(Object.values(mergedData));
            } else {
                renderMap(mapData[year]);
            }
        }

        function moveToCurrentLocation() {
            map.locate({setView: true, maxZoom: 16});
        }

        // ë°ì´í„° ê°±ì‹  (ìºì‹œ ì‚­ì œ í›„ ìƒˆë¡œê³ ì¹¨)
        function clearCache() {
            if(confirm('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œ ë°›ì•„ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('cached_map_data_2023');
                localStorage.removeItem('cached_map_data_2024');
                localStorage.removeItem('cached_map_data_2025');
                location.reload();
            }
        }
    </script>
</body>
</html>
