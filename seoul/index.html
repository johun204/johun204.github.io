<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ì„œìš¸ì‹œ ì—…ë¬´ì¶”ì§„ë¹„ ë§›ì§‘ ì§€ë„ (Final)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        #map { width: 100%; height: 100vh; z-index: 1; background: #f0f0f0; }
        
        /* 1. í´ëŸ¬ìŠ¤í„° ì•„ì´ì½˜ ë””ìì¸ (í¬ê¸°ë³„ ìƒ‰ìƒ ë³€í™”) */
        .cluster-marker {
            background-color: rgba(0, 123, 255, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .cluster-marker.medium { background-color: #fd7e14; } /* 100ê°œ ì´ìƒ ì£¼í™©ìƒ‰ */
        .cluster-marker.large { background-color: #dc3545; }  /* 1000ê°œ ì´ìƒ ë¹¨ê°„ìƒ‰ */

        /* 2. ìƒë‹¨ ì—°ë„ ì»¨íŠ¸ë¡¤ */
        .year-controls {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.95);
            padding: 6px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; gap: 5px; white-space: nowrap;
        }
        .year-btn {
            border: none; background: transparent; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px;
            color: #555; transition: 0.2s;
        }
        .year-btn:hover { background: #f1f1f1; }
        .year-btn.active { background: #212529; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* 3. ìš°ì¸¡ í•˜ë‹¨ í˜„ìœ„ì¹˜ ë²„íŠ¼ */
        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 22px; color: #333;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .gps-btn:active { transform: scale(0.9); }

        /* 4. ìš°ì¸¡ ìƒë‹¨ ë¦¬ì…‹ ë²„íŠ¼ */
        .reset-btn {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: white; border: 1px solid #ddd;
            padding: 6px 10px; font-size: 11px; border-radius: 8px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #666;
        }

        /* 5. ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 2000; background: rgba(0,0,0,0.8); color: white;
            padding: 20px 30px; border-radius: 12px; font-size: 15px; display: none;
            backdrop-filter: blur(2px);
        }

        /* íŒì—… ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
        .leaflet-popup-content-wrapper { border-radius: 12px; }
        .leaflet-popup-content { margin: 15px; }
    </style>
</head>
<body>

    <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> ë°ì´í„° ì²˜ë¦¬ ì¤‘...</div>
    
    <button class="reset-btn" onclick="clearCache()">
        <i class="fa-solid fa-rotate-right"></i> ë°ì´í„° ê°±ì‹ 
    </button>

    <div class="year-controls">
        <button class="year-btn active" onclick="setYear('all', this)">ì „ì²´</button>
        <button class="year-btn" onclick="setYear('2025', this)">2025</button>
        <button class="year-btn" onclick="setYear('2024', this)">2024</button>
        <button class="year-btn" onclick="setYear('2023', this)">2023</button>
    </div>

    <button class="gps-btn" onclick="moveToCurrentLocation()">
        <i class="fa-solid fa-location-crosshairs"></i>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://unpkg.com/supercluster@7.1.5/dist/supercluster.min.js"></script>

    <script>
        // ============================================================
        // 1. ì´ˆê¸° ì„¤ì • (ì§€ë„, ì €ì¥ì†Œ)
        // ============================================================
        localforage.config({ name: 'SeoulFoodMap', storeName: 'map_data_v3' });
        
        const map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 14);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap', maxZoom: 19
        }).addTo(map);

        // í˜„ìœ„ì¹˜ ë§ˆì»¤ìš© ë ˆì´ì–´
        const gpsLayer = L.layerGroup().addTo(map);

        // ğŸš€ Supercluster ì—”ì§„ ì„¤ì • (ëŒ€ìš©ëŸ‰ ì²˜ë¦¬ì˜ í•µì‹¬)
        const index = new Supercluster({
            radius: 60,   // í´ëŸ¬ìŠ¤í„°ë§ ë°˜ê²½ (px)
            maxZoom: 18   // ì´ ë ˆë²¨ ì´ìƒ í™•ëŒ€í•˜ë©´ í´ëŸ¬ìŠ¤í„°ë§ ì¤‘ë‹¨ (ë‹¨, ê²¹ì¹œ ê±´ ìœ ì§€)
        });

        let markersLayer = L.layerGroup().addTo(map); // ì‹¤ì œ ë§ˆì»¤ê°€ ê·¸ë ¤ì§ˆ ë ˆì´ì–´
        let mapDataMap = {}; // ì—°ë„ë³„ ë°ì´í„° ì €ì¥ì†Œ

        // ============================================================
        // 2. ë°ì´í„° ë¡œë“œ ë° ìºì‹± (IndexedDB)
        // ============================================================
        async function loadDataWithCache(year) {
            const cacheKey = `geo_data_${year}`;
            const loadingEl = document.getElementById('loading');
            
            try {
                // 1) ìºì‹œ í™•ì¸
                const cached = await localforage.getItem(cacheKey);
                if (cached) return cached;

                // 2) ë‹¤ìš´ë¡œë“œ
                loadingEl.style.display = 'block';
                const res = await fetch(`./map_data_${year}.json`);
                if (!res.ok) throw new Error('File not found');
                const json = await res.json();

                // 3) GeoJSON ë³€í™˜ (ë¯¸ë¦¬ ë³€í™˜í•´ì„œ ì €ì¥)
                const geoJsonPoints = json
                    .filter(item => item.lat && item.lng)
                    .map(item => ({
                        type: 'Feature',
                        properties: {
                            name: item.name,
                            address: item.address,
                            total_amount: item.total_amount,
                            visit_count: item.visit_count
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [item.lng, item.lat]
                        }
                    }));

                // 4) ì €ì¥
                await localforage.setItem(cacheKey, geoJsonPoints);
                return geoJsonPoints;

            } catch (err) {
                console.error(`Error loading ${year}:`, err);
                return [];
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë”© ì‹¤í–‰
        (async function init() {
            const results = await Promise.all([
                loadDataWithCache('2023'),
                loadDataWithCache('2024'),
                loadDataWithCache('2025')
            ]);
            mapDataMap['2023'] = results[0];
            mapDataMap['2024'] = results[1];
            mapDataMap['2025'] = results[2];
            
            // ë°ì´í„° ë¡œë“œ ì™„ë£Œ í›„ ì „ì²´ ë³´ê¸° ì‹¤í–‰
            setYear('all', document.querySelector('.year-btn.active'));
        })();


        // ============================================================
        // 3. ë°ì´í„° ë³‘í•© (Aggregation) - í•µì‹¬ ë¡œì§ â­
        // ============================================================
        // ê°™ì€ ì‹ë‹¹(ì´ë¦„+ì£¼ì†Œ)ì´ë©´ ê¸ˆì•¡ê³¼ íšŸìˆ˜ë¥¼ í•©ì¹©ë‹ˆë‹¤.
        function aggregateData(geoJsonPoints) {
            const mergedMap = {};

            geoJsonPoints.forEach(pt => {
                const props = pt.properties;
                const key = `${props.name}|${props.address}`; // ê³ ìœ  í‚¤ ìƒì„±

                if (!mergedMap[key]) {
                    // ì‹ ê·œ ë“±ë¡: ì›ë³¸ ë³´í˜¸ë¥¼ ìœ„í•´ ë³µì‚¬í•´ì„œ ì €ì¥
                    mergedMap[key] = {
                        type: 'Feature',
                        properties: { ...props }, 
                        geometry: { ...pt.geometry }
                    };
                } else {
                    // ì¤‘ë³µ ë°œê²¬: ê¸ˆì•¡ê³¼ íšŸìˆ˜ ëˆ„ì 
                    mergedMap[key].properties.total_amount += props.total_amount;
                    mergedMap[key].properties.visit_count += props.visit_count;
                }
            });

            return Object.values(mergedMap);
        }

        function setYear(year, btn) {
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼
            document.querySelectorAll('.year-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let rawPoints = [];

            if (year === 'all') {
                // ëª¨ë“  ì—°ë„ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹¨
                rawPoints = [
                    ...mapDataMap['2023'], 
                    ...mapDataMap['2024'], 
                    ...mapDataMap['2025']
                ];
            } else {
                rawPoints = mapDataMap[year] || [];
            }

            // â­ ë³‘í•© ì‹¤í–‰ (ì—¬ê¸°ì„œ ì¤‘ë³µì´ ì œê±°ë˜ê³  í†µê³„ê°€ í•©ì³ì§)
            const aggregatedPoints = aggregateData(rawPoints);
            
            // Superclusterì— ë°ì´í„° ì…ë ¥
            index.load(aggregatedPoints);
            
            updateMap();
        }


        // ============================================================
        // 4. ì§€ë„ ë Œë”ë§ (Supercluster)
        // ============================================================
        function updateMap() {
            const bounds = map.getBounds();
            const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
            const zoom = map.getZoom();

            // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ë°ì´í„°ë§Œ ê³„ì‚°í•´ì„œ ê°€ì ¸ì˜´
            const clusters = index.getClusters(bbox, zoom);
            markersLayer.clearLayers();

            clusters.forEach(feature => {
                const [lng, lat] = feature.geometry.coordinates;
                const isCluster = feature.properties.cluster;

                if (isCluster) {
                    // [í´ëŸ¬ìŠ¤í„° ë§ˆì»¤]
                    const count = feature.properties.point_count;
                    let sizeClass = count > 1000 ? 'large' : (count > 100 ? 'medium' : '');
                    let size = count > 1000 ? 55 : (count > 100 ? 45 : 35);

                    const icon = L.divIcon({
                        html: `<div class="cluster-marker ${sizeClass}" style="width:${size}px; height:${size}px;">${shortenNum(count)}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: [size, size]
                    });

                    const marker = L.marker([lat, lng], { icon: icon });

                    // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ ë™ì‘
                    marker.on('click', () => {
                        const expansionZoom = index.getClusterExpansionZoom(feature.properties.cluster_id);
                        
                        // ë” ì´ìƒ ì¤Œí•  ìˆ˜ ì—†ìœ¼ë©´ ìš”ì•½ íŒì—… í‘œì‹œ
                        if (expansionZoom > 19 || zoom >= 18) {
                            showClusterPopup(feature, lat, lng);
                        } else {
                            map.setView([lat, lng], expansionZoom);
                        }
                    });
                    markersLayer.addLayer(marker);

                } else {
                    // [ê°œë³„ ì‹ë‹¹ ë§ˆì»¤]
                    const props = feature.properties;
                    const marker = L.marker([lat, lng]);
                    const avgPrice = Math.round(props.total_amount / props.visit_count);

                    const popupContent = `
                        <div style="text-align:center; min-width:180px;">
                            <h3 style="margin:0 0 5px; color:#212529; font-size:16px;">${props.name}</h3>
                            <p style="margin:0 0 10px; color:#868e96; font-size:12px;">${props.address}</p>
                            <div style="background:#f8f9fa; padding:10px; border-radius:8px; text-align:left;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                    <span style="color:#495057;">ğŸ’° ì´ ì‚¬ìš©ì•¡</span>
                                    <span style="font-weight:bold; color:#212529;">${props.total_amount.toLocaleString()}ì›</span>
                                </div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="color:#495057;">ğŸš© ë°©ë¬¸íšŸìˆ˜</span>
                                    <span style="font-weight:bold; color:#212529;">${props.visit_count}íšŒ</span>
                                </div>
                                <hr style="margin:8px 0; border-top:1px dashed #ced4da;">
                                <div style="text-align:right; font-size:12px; color:#fa5252;">
                                    1íšŒ í‰ê· : <b>${avgPrice.toLocaleString()}ì›</b>
                                </div>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                }
            });
        }

        // ì§€ë„ ì´ë™ ì‹œë§ˆë‹¤ ì—…ë°ì´íŠ¸
        map.on('moveend', updateMap);


        // ============================================================
        // 5. ìœ í‹¸ë¦¬í‹° (í˜„ìœ„ì¹˜, ìˆ«ìì¶•ì•½, íŒì—…, ë¦¬ì…‹)
        // ============================================================
        
        function moveToCurrentLocation() {
            map.locate({setView: true, maxZoom: 16});
        }

        map.on('locationfound', e => {
            gpsLayer.clearLayers();
            L.circle(e.latlng, { radius: e.accuracy / 2, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.1 }).addTo(gpsLayer);
            L.circleMarker(e.latlng, { radius: 8, color: '#fff', fillColor: '#4285F4', fillOpacity: 1 }).addTo(gpsLayer);
        });

        // 1200 -> 1.2k ë³€í™˜
        function shortenNum(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num;
        }

        // ê²¹ì¹œ ë§ˆì»¤ ìš”ì•½ íŒì—…
        function showClusterPopup(clusterFeature, lat, lng) {
            const leaves = index.getLeaves(clusterFeature.properties.cluster_id, Infinity);
            
            let totalMoney = 0;
            let totalCount = 0;
            let names = {};

            leaves.forEach(leaf => {
                totalMoney += leaf.properties.total_amount;
                totalCount += leaf.properties.visit_count;
                const n = leaf.properties.name;
                names[n] = (names[n] || 0) + 1;
            });

            // ë§ì´ ê°„ ìˆœì„œë¡œ ì •ë ¬í•´ì„œ ìƒìœ„ 3ê°œë§Œ í‘œì‹œ
            const topList = Object.entries(names)
                .sort((a,b) => b[1] - a[1])
                .slice(0, 3)
                .map(([name, cnt]) => `<li style="margin-bottom:3px;">${name} <span style="color:gray; font-size:11px;">(${cnt}ê±´)</span></li>`)
                .join('');

            const content = `
                <div style="min-width:200px;">
                    <h3 style="margin:0 0 10px; font-size:15px;">ğŸ¢ ë°€ì§‘ ì§€ì—­ ì •ë³´</h3>
                    <div style="background:#e9ecef; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <b>ì´ ê¸ˆì•¡:</b> ${totalMoney.toLocaleString()}ì›<br>
                        <b>ì´ íšŸìˆ˜:</b> ${totalCount.toLocaleString()}ê±´
                    </div>
                    <p style="margin:5px 0; font-weight:bold; font-size:12px;">ğŸ”¥ ì£¼ìš” ì‹ë‹¹:</p>
                    <ul style="padding-left:20px; margin:0; font-size:12px;">${topList}</ul>
                    ${Object.keys(names).length > 3 ? `<p style="font-size:11px; color:#868e96; margin-top:5px;">ì™¸ ${Object.keys(names).length - 3}ê³³</p>` : ''}
                </div>
            `;

            L.popup().setLatLng([lat, lng]).setContent(content).openOn(map);
        }

        async function clearCache() {
            if(confirm('ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await localforage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
