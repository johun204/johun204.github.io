<html>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<script>
const Ufee = 0.05 / 100, Bfee = 0.12 / 100;
//const Ufee = 0.0, Bfee = 0.0;
var aFlag = false;
var Uask = 0, Ubid = 0, Utimestamp = 0;
var Bask = 0, Bbid = 0, Btimestamp = 0;
Number.prototype.fillZero = function(width){
    let n = String(this);
    return n.length >= width ? n:new Array(width-n.length+1).join('0')+n;
}
function getMarket(){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == XMLHttpRequest.DONE) {
			var jsondata = JSON.parse(xhr.responseText);
			var market = document.getElementById('market');
			for(var i=0;i<jsondata.length;i++){
				if(jsondata[i]['market'].length < 4 || jsondata[i]['market'].substr(0,4) != 'KRW-')continue;
				var opt = document.createElement('option');
				opt.value = jsondata[i]['market'].substr(4);
				//opt.innerHTML = jsondata[i]['market'].substr(4) + '(' + jsondata[i]['korean_name'] + ')';
				opt.innerHTML = jsondata[i]['market'].substr(4);
				market.appendChild(opt);
			}
			if(localStorage.getItem('arbitrage_market') != null)document.getElementById('market').value = localStorage.getItem('arbitrage_market');
			initTimer();
		}
	}
	xhr.open('GET', 'https://api.upbit.com/v1/market/all', false);
	xhr.send(null);
}
function getUpbit(){
	const market = document.getElementById('market').value;
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == XMLHttpRequest.DONE) {
			var json = JSON.parse(xhr.responseText);
			if(document.getElementById('market').value == market){
				setU_div(json[0]['timestamp'], json[0]['orderbook_units'][0]['ask_price'], json[0]['orderbook_units'][0]['bid_price']);
			}
		}
	}
	xhr.open('GET', 'https://api.upbit.com/v1/orderbook?markets=KRW-' + market, true);
	xhr.send(null);
}
function getBithumb(){
	const market = document.getElementById('market').value;
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == XMLHttpRequest.DONE) {
			var json = JSON.parse(xhr.responseText);
			if(document.getElementById('market').value == market){
				setB_div(Number(json['data']['timestamp']), json['data']['asks'][0]['price'], json['data']['bids'][0]['price']);
			}
		}
	}
	xhr.open('GET', 'https://api.bithumb.com/public/orderbook/' + market + '_KRW?count=15', true);
	xhr.send(null);
}
function setU_div(timestamp, asks, bids){
	if(timestamp > Utimestamp){
		var date = new Date(timestamp);
		const dt = date.getFullYear() + '년 ' + (date.getMonth()+1) + '월 ' + date.getDate() + '일 ' + date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0') + ':' + date.getSeconds().toString().padStart(2, '0') + '.' + (timestamp%1000).toString().padStart(3, '0');
		Utimestamp = timestamp;
		Uask = asks;
		Ubid = bids;
		document.getElementById('U_div').innerText = 'U ' + dt + '\n' + asks + ' ' + bids+ '\n';
		aFlag = true;
	}
}
function setB_div(timestamp, asks, bids){
	if(timestamp > Btimestamp){
		var date = new Date(timestamp);
		const dt = date.getFullYear() + '년 ' + (date.getMonth()+1) + '월 ' + date.getDate() + '일 ' + date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0') + ':' + date.getSeconds().toString().padStart(2, '0') + '.' + (timestamp%1000).toString().padStart(3, '0');
		Btimestamp = timestamp;
		Bask = asks;
		Bbid = bids;
		document.getElementById('B_div').innerText = 'B ' + dt + '\n' + asks + ' ' + bids+ '\n';
		aFlag = true;
	}
}
function arbitrage(){
	if(aFlag && Utimestamp > 0 && Btimestamp > 0){
		if(Bask * (1 + Bfee) < Ubid / (1 + Ufee)){
			console.log("B ask < U bid (" + (Utimestamp - Btimestamp) + ")\n" + Bask + "," + Ubid + "\n" + Math.floor(Bask * (1 + Bfee)) + "," + Math.floor(Ubid / (1 + Ufee)));
		}
		if(Uask * (1 + Ufee) < Bbid / (1 + Bfee)){
			console.log("U ask < B bid (" + (Utimestamp - Btimestamp) + ")\n" + Uask + "," + Bbid + "\n" + Math.floor(Uask * (1 + Ufee)) + "," + Math.floor(Bbid / (1 + Bfee)));
		}
		aFlag = false;
	}
}
function chageMarket(){
	Utimestamp = 0;
	Btimestamp = 0;
	localStorage.setItem('arbitrage_market', document.getElementById('market').value);
}
function initScreen(){
	getMarket();
}
function initTimer(){
	getUpbit();
	getBithumb();
	setInterval(getUpbit, 100);
	setInterval(getBithumb, 100);
	setInterval(arbitrage, 50);
}
window.addEventListener('load', initScreen);
</script>
<body>
<select id='market' onchange='chageMarket()'></select>
<div id='U_div'></div>
<hr>
<div id='B_div'></div>
</body>
</html>