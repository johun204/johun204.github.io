<html>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<script>
var Uprice = 0, Utimestamp = 0;
var Bprice = 0, Btimestamp = 0;
function getMarket(){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == XMLHttpRequest.DONE) {
			var jsondata = JSON.parse(xhr.responseText);
			var market = document.getElementById('market');
			for(var i=0;i<jsondata.length;i++){
				if(jsondata[i]['market'].length < 4 || jsondata[i]['market'].substr(0,4) != 'KRW-')continue;
				var opt = document.createElement('option');
				opt.value = jsondata[i]['market'].substr(4);
				//opt.innerHTML = jsondata[i]['korean_name'] + '(' + jsondata[i]['market'].substr(4) + ')';
				opt.innerHTML = jsondata[i]['market'].substr(4);
				market.appendChild(opt);
			}
			if(localStorage.getItem('arbitrage_market') != null)document.getElementById('market').value = localStorage.getItem('market');
			initTimer();
		}
	}
	xhr.open('GET', 'https://api.upbit.com/v1/market/all', false);
	xhr.send(null);
}
function getUpbit(){
	const market = document.getElementById('market').value;
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == XMLHttpRequest.DONE) {
			var json = JSON.parse(xhr.responseText);
			console.log(json);
			setU_div(json[0]['timestamp'], json[0]['orderbook_units'][0]['ask_price'], json[0]['orderbook_units'][0]['bid_price']);
		}
	}
	xhr.open('GET', 'https://api.upbit.com/v1/orderbook?markets=KRW-' + market, true);
	xhr.send(null);
}
function getBithumb(){
	const market = document.getElementById('market').value;
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == XMLHttpRequest.DONE) {
			var json = JSON.parse(xhr.responseText);
			console.log(json);
			setB_div(Number(json['data']['timestamp']), json['data']['asks'][0]['price'], json['data']['bids'][0]['price']);
		}
	}
	xhr.open('GET', 'https://api.bithumb.com/public/orderbook/' + market + '_KRW?count=15', true);
	xhr.send(null);
}
function setU_div(timestamp, asks, bids){
	if(timestamp > Utimestamp){
		Utimestamp = timestamp;
		document.getElementById('U_div').innerText = asks + ' ' + bids;
	}
}
function setB_div(timestamp, asks, bids){
	if(timestamp > Btimestamp){
		Btimestamp = timestamp;
		document.getElementById('B_div').innerText = asks + ' ' + bids;
	}
}
function initScreen(){
	getMarket();
}
function initTimer(){
	getUpbit();
	getBithumb();
	setInterval(getUpbit, 100);
	setInterval(getBithumb, 100);
}
window.addEventListener('load', initScreen);
</script>
<body>
<select id='market' class='form-select'></select>
<div id='U_div'></div>
<hr>
<div id='B_div'></div>
</body>
</html>