<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi Meter</title>

<link rel="icon" type="image/png" sizes="16x16" href="/taxi/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/taxi/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">
<link rel="manifest" href="/taxi/site.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Taxi Meter">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body {
  margin: 0; background: #0a0a0a;
  font-family: 'Courier New', monospace; color: #00ff9c;
  overflow: hidden;
}

#map { height: 45vh; }

.panel {
  height: 55vh; background: #111;
  border-top: 4px solid #00ff9c; padding: 12px;
  display: flex; flex-direction: column;
  justify-content: space-between; position: relative; box-sizing: border-box;
}

.fare-display {
  font-size: 3.2em; text-align: center; font-weight: bold;
  color: #fff; text-shadow: 0 0 20px #00ff9c; margin: 5px 0;
}

.info-row { display: flex; justify-content: space-around; margin-bottom: 5px; }
.display { font-size: 1.5em; text-align: center; text-shadow: 0 0 10px #00ff9c; }

.horse-container { height: 50px; display: flex; justify-content: center; align-items: center; }
.horse { font-size: 35px; animation: trot 0.6s infinite steps(2); animation-play-state: paused; }

@keyframes trot {
  0% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  100% { transform: translateX(-5px); }
}

.controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
button {
  padding: 15px; font-size: 1.2em; background: #00ff9c;
  color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 8px;
}
#history-btn { background: #333; color: #00ff9c; border: 1px solid #00ff9c; }

/* HISTORY MODAL */
#history-modal {
  position: absolute; inset: 0; background: rgba(0,0,0,0.95);
  display: none; flex-direction: column; padding: 20px; z-index: 1000;
  border-top: 4px solid #00ff9c;
}
.history-list { overflow-y: auto; flex-grow: 1; margin-bottom: 15px; }
.history-item {
  border-bottom: 1px solid #333; padding: 10px 0;
  display: flex; justify-content: space-between; align-items: center;
}
.history-item div { font-size: 0.9em; }
.del-btn { color: #ff4b4b; cursor: pointer; padding: 5px 10px; border: 1px solid #ff4b4b; border-radius: 4px; font-size: 0.8em; }

.panel::after {
  content: ""; position: absolute; inset: 0; pointer-events: none;
  background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.02), rgba(255,255,255,0.02) 1px, transparent 2px, transparent 4px);
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div id="history-modal">
    <h2 style="margin-top:0">Driving History</h2>
    <div class="history-list" id="history-list"></div>
    <div style="display:flex; gap:10px;">
        <button style="flex:1" onclick="toggleHistory()">Îã´Í∏∞</button>
        <button style="flex:1; background:#ff4b4b;" onclick="clearAllHistory()">Ï†ÑÏ≤¥ÏÇ≠Ï†ú</button>
    </div>
  </div>

  <div class="horse-container"><div class="horse" id="horse">üêé</div></div>
  <div class="fare-display" id="fare">‚Ç©4,800</div>
  <div class="info-row">
    <div class="display" id="time">00:00:00</div>
    <div class="display" id="distance">0.00 km</div>
  </div>
  <div class="display" id="speed" style="font-size: 1em; color: #888;">0 km/h</div>

  <div class="controls">
    <button id="btn">Ï£ºÌñâ ÏãúÏûë</button>
    <button id="history-btn" onclick="toggleHistory()">Í∏∞Î°ù Î≥¥Í∏∞</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marker = L.marker([37.5665,126.9780]).addTo(map);
let pathLine = L.polyline([], { color: '#00008B', weight: 6, opacity: 0.8 }).addTo(map);

let running = false;
let totalDistance = 0, totalSeconds = 0, lowSpeedSeconds = 0, currentSpeed = 0;
let lastPoint = null, timer = null, wakeLock = null;

const fareEl = document.getElementById("fare"), timeEl = document.getElementById("time");
const distEl = document.getElementById("distance"), speedEl = document.getElementById("speed");
const horseEl = document.getElementById("horse"), btn = document.getElementById("btn");

/* FARE CALCULATION */
function getFare() {
    const h = new Date().getHours();
    let rate = 1.0;
    if ((h >= 22 && h < 23) || (h >= 2 && h < 4)) rate = 1.2;
    else if (h >= 23 || h < 2) rate = 1.4;

    const BASE = 4800 * rate, BASE_DIST = 1600, DIST_UNIT = 131, TIME_UNIT = 30, STEP = 100 * rate;
    let extra = 0;
    if (totalDistance > BASE_DIST) extra += Math.floor((totalDistance - BASE_DIST) / DIST_UNIT) * STEP;
    if (lowSpeedSeconds > 0) extra += Math.floor(lowSpeedSeconds / TIME_UNIT) * STEP;

    return Math.floor((BASE + extra) / 10) * 10;
}

/* HISTORY LOGIC */
function saveRecord() {
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    const newRecord = {
        id: Date.now(),
        date: new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }),
        fare: fareEl.innerText,
        dist: distEl.innerText,
        time: timeEl.innerText
    };
    records.unshift(newRecord);
    localStorage.setItem('taxi_records', JSON.stringify(records));
}

function renderHistory() {
    const list = document.getElementById('history-list');
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    list.innerHTML = records.length ? '' : '<p style="color:#666">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
    records.forEach(r => {
        list.innerHTML += `
            <div class="history-item">
                <div>
                    <strong style="color:#fff">${r.fare}</strong> | ${r.dist}<br>
                    <small style="color:#888">${r.date} (${r.time})</small>
                </div>
                <div class="del-btn" onclick="deleteRecord(${r.id})">ÏÇ≠Ï†ú</div>
            </div>`;
    });
}

function deleteRecord(id) {
    let records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    records = records.filter(r => r.id !== id);
    localStorage.setItem('taxi_records', JSON.stringify(records));
    renderHistory();
}

function clearAllHistory() {
    if(confirm("Î™®Îì† Ï£ºÌñâ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) {
        localStorage.removeItem('taxi_records');
        renderHistory();
    }
}

function toggleHistory() {
    const modal = document.getElementById('history-modal');
    const isVisible = modal.style.display === 'flex';
    modal.style.display = isVisible ? 'none' : 'flex';
    if (!isVisible) renderHistory();
}

/* GPS & ENGINE */
navigator.geolocation.watchPosition(pos => {
  const point = { lat: pos.coords.latitude, lng: pos.coords.longitude, t: Date.now() };
  marker.setLatLng([point.lat, point.lng]);
  if (running) {
    map.panTo([point.lat, point.lng]);
    if (lastPoint) {
      const d = L.latLng(lastPoint.lat, lastPoint.lng).distanceTo(L.latLng(point.lat, point.lng));
      const dt = (point.t - lastPoint.t) / 1000;
      currentSpeed = dt > 0 ? (d / dt) * 3.6 : 0;
      if (d > 2) { totalDistance += d; pathLine.addLatLng([point.lat, point.lng]); }
    }
    lastPoint = point;
  }
}, null, { enableHighAccuracy: true });

btn.onclick = async () => {
  if (!running) {
    running = true; totalDistance = 0; totalSeconds = 0; lowSpeedSeconds = 0;
    pathLine.setLatLngs([]); btn.innerText = "Ï£ºÌñâ Ï¢ÖÎ£å"; btn.style.background = "#ff4b4b";
    timer = setInterval(() => {
        totalSeconds++;
        const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
        const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
        const s = String(totalSeconds % 60).padStart(2, '0');
        timeEl.innerText = `${h}:${m}:${s}`;
        distEl.innerText = (totalDistance / 1000).toFixed(2) + " km";
        speedEl.innerText = Math.round(currentSpeed) + " km/h";
        if (currentSpeed < 15.72) lowSpeedSeconds++;
        horseEl.style.animationPlayState = currentSpeed < 15.72 ? "paused" : "running";
        fareEl.innerText = "‚Ç©" + getFare().toLocaleString();
    }, 1000);
    try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
  } else {
    running = false; clearInterval(timer);
    btn.innerText = "Ï£ºÌñâ ÏãúÏûë"; btn.style.background = "#00ff9c";
    saveRecord();
    alert(`Ïö¥Ìñâ ÏôÑÎ£å: ${fareEl.innerText}`);
    if (wakeLock) wakeLock.release();
  }
};
</script>
</body>
</html>
