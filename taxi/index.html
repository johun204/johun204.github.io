<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi Meter</title>
<!-- Standard favicon -->
<link rel="icon" type="image/png" sizes="16x16" href="/taxi/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/taxi/favicon-32x32.png">

<!-- Apple Touch Icon (iOS í™ˆ í™”ë©´) -->
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">

<!-- Android / PWA Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="/taxi/icon-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/taxi/icon-512x512.png">

<!-- Android Chrome Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="/taxi/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/taxi/android-chrome-512x512.png">

<!-- Web App Manifest (PWA) -->
<link rel="manifest" href="/taxi/site.webmanifest">

<!-- Theme Color (Android status bar) -->
<meta name="theme-color" content="#ffffff">

<!-- iOS Safari PWA mode -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Taxi Meter">

<!-- Microsoft Tile -->
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/taxi/icon-192x192.png">
  
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body {
  margin: 0;
  background: #0a0a0a;
  font-family: 'Courier New', monospace;
  color: #00ff9c;
  overflow: hidden;
}

/* MAP */
#map {
  height: 50vh;
  filter: contrast(1.2) brightness(0.8) grayscale(0.5);
}

/* PANEL */
.panel {
  height: 50vh;
  background: #111;
  border-top: 4px solid #00ff9c;
  padding: 14px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  position: relative;
  box-sizing: border-box;
}

/* DISPLAY */
.info-row { display: flex; justify-content: space-around; margin-top: 10px; }
.display {
  font-size: 1.8em;
  text-align: center;
  text-shadow: 0 0 10px #00ff9c;
}
.fare-display {
  font-size: 3.5em;
  text-align: center;
  font-weight: bold;
  margin: 10px 0;
  color: #fff;
  text-shadow: 0 0 20px #00ff9c;
}

/* HORSE */
.horse-container { height: 60px; display: flex; justify-content: center; align-items: center; }
.horse {
  font-size: 40px;
  animation: trot 0.6s infinite steps(2);
  animation-play-state: paused;
}

@keyframes trot {
  0% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  100% { transform: translateX(-5px); }
}

/* BUTTON */
button {
  padding: 20px;
  font-size: 1.5em;
  background: #00ff9c;
  color: black;
  border: none;
  font-weight: bold;
  cursor: pointer;
  border-radius: 8px;
}
button:active { background: #009966; }

/* CRT SCANLINE */
.panel::after {
  content: ""; position: absolute; inset: 0;
  background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 1px, transparent 2px, transparent 4px);
  pointer-events: none;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="horse-container">
    <div class="horse" id="horse">ğŸ</div>
  </div>

  <div class="fare-display" id="fare">â‚©4,800</div>
  
  <div class="info-row">
    <div class="display" id="time">00:00:00</div>
    <div class="display" id="distance">0.00 km</div>
  </div>
  
  <div class="display" id="speed" style="font-size: 1.2em; color: #888;">0 km/h</div>

  <button id="btn">ì£¼í–‰ ì‹œì‘</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map', { zoomControl: false }).setView([37.5665, 126.9780], 16);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let marker = L.marker([37.5665,126.9780]).addTo(map);
let pathLine = L.polyline([], { color:'#00ff9c', weight: 5 }).addTo(map);

let running = false;
let totalDistance = 0;
let totalSeconds = 0;
let lowSpeedSeconds = 0; // ì‹œì† 15.72km ë¯¸ë§Œ ëˆ„ì  ì‹œê°„
let lastPoint = null;
let currentSpeed = 0;
let timer = null;
let wakeLock = null;

const fareEl = document.getElementById("fare");
const timeEl = document.getElementById("time");
const distEl = document.getElementById("distance");
const speedEl = document.getElementById("speed");
const horseEl = document.getElementById("horse");
const btn = document.getElementById("btn");

/* GPS DISTANCE (Haversine) */
function calcDistance(a, b) {
  const R = 6371000;
  const dLat = (b.lat - a.lat) * Math.PI / 180;
  const dLon = (b.lng - a.lng) * Math.PI / 180;
  const x = Math.sin(dLat / 2) ** 2 + Math.cos(a.lat * Math.PI / 180) * Math.cos(b.lat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
}

/* REAL-TIME FARE ENGINE */
function updateFareDisplay() {
  const h = new Date().getHours();
  let rate = 1.0;
  if ((h >= 22 && h < 23) || (h >= 2 && h < 4)) rate = 1.2; // 20% í• ì¦
  else if (h >= 23 || h < 2) rate = 1.4; // 40% í• ì¦

  const BASE = 4800 * rate;
  const BASE_DIST = 1600;
  const DIST_UNIT = 131;
  const TIME_UNIT = 30;
  const STEP = 100 * rate;

  let extra = 0;
  // ê±°ë¦¬ ìš”ê¸ˆ
  if (totalDistance > BASE_DIST) {
    extra += Math.floor((totalDistance - BASE_DIST) / DIST_UNIT) * STEP;
  }
  // ì‹œê°„ ìš”ê¸ˆ (ì €ì† ì£¼í–‰ ì‹œì—ë§Œ ìŒ“ì¸ ì´ˆ ê¸°ì¤€)
  if (lowSpeedSeconds > 0) {
    extra += Math.floor(lowSpeedSeconds / TIME_UNIT) * STEP;
  }

  const finalFare = Math.floor((BASE + extra) / 10) * 10;
  fareEl.innerText = "â‚©" + finalFare.toLocaleString();
}

/* GPS TRACKING */
navigator.geolocation.watchPosition(pos => {
  const now = Date.now();
  const point = { lat: pos.coords.latitude, lng: pos.coords.longitude, t: now };

  marker.setLatLng([point.lat, point.lng]);
  if (running) {
    map.panTo([point.lat, point.lng]);
    if (lastPoint) {
      const d = calcDistance(lastPoint, point);
      const dt = (point.t - lastPoint.t) / 1000;
      currentSpeed = dt > 0 ? (d / dt) * 3.6 : 0;
      
      // GPS íŠ€ëŠ” í˜„ìƒ ë°©ì§€ (ì •ì§€ ì¤‘ ì˜¤ì°¨ ë²”ìœ„ 2m ë¬´ì‹œ)
      if (d > 2) {
        totalDistance += d;
        pathLine.addLatLng([point.lat, point.lng]);
      }
    }
    lastPoint = point;
  }
}, err => console.error(err), { enableHighAccuracy: true });

/* TICKER (Every 1 Sec) */
function startTicker() {
  timer = setInterval(() => {
    totalSeconds++;
    
    // ì‹œê°„ í¬ë§·íŒ…
    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const s = String(totalSeconds % 60).padStart(2, '0');
    timeEl.innerText = `${h}:${m}:${s}`;

    // ê±°ë¦¬ í¬ë§·íŒ…
    distEl.innerText = (totalDistance / 1000).toFixed(2) + " km";
    speedEl.innerText = Math.round(currentSpeed) + " km/h";

    // ë™ì‹œë³‘ì‚°ì œ í•µì‹¬: 15.72km/h ë¯¸ë§Œì¼ ë•Œë§Œ ì‹œê°„ ëˆ„ì 
    if (currentSpeed < 15.72) {
      lowSpeedSeconds++;
      horseEl.style.animationPlayState = "paused";
    } else {
      horseEl.style.animationPlayState = "running";
      horseEl.style.animationDuration = currentSpeed > 40 ? "0.2s" : "0.5s";
    }

    updateFareDisplay();
  }, 1000);
}

/* CONTROLS */
btn.onclick = async () => {
  if (!running) {
    // Start
    running = true;
    totalDistance = 0; totalSeconds = 0; lowSpeedSeconds = 0; currentSpeed = 0;
    pathLine.setLatLngs([]);
    btn.innerText = "ì£¼í–‰ ì¢…ë£Œ";
    btn.style.background = "#ff4b4b";
    startTicker();
    try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
  } else {
    // Stop
    running = false;
    clearInterval(timer);
    btn.innerText = "ì£¼í–‰ ì‹œì‘";
    btn.style.background = "#00ff9c";
    alert(`ìš´í–‰ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nìµœì¢… ìš”ê¸ˆ: ${fareEl.innerText}`);
    if (wakeLock) { wakeLock.release(); wakeLock = null; }
  }
};
</script>
</body>
</html>
