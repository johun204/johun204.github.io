<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Taxi Meter Pro</title>

<link rel="icon" type="image/png" sizes="16x16" href="/taxi/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/taxi/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">
<link rel="manifest" href="/taxi/site.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Taxi Meter">
    
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
:root { --neon-green: #00ff9c; --alert-red: #ff4b4b; --bg-dark: #0a0a0a; --soft-white: #e0e0e0; }
body {
    margin: 0; background: var(--bg-dark);
    font-family: 'Courier New', monospace; color: var(--neon-green);
    overflow: hidden; touch-action: manipulation;
}
#map { height: 42vh; width: 100%; background: #f0f0f0; position: relative; }
.panel { height: 58vh; background: #111; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; position: relative; box-sizing: border-box; z-index: 1; }
.panel > *:not(.scanline) { position: relative; z-index: 2; }
.nav-arrow { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #007AFF; filter: drop-shadow(0 0 5px rgba(0,0,0,0.3)); transform-origin: center; transition: transform 0.2s ease-out; }
.fare-container { background: #000; border: 2px solid #333; padding: 10px; border-radius: 12px; box-shadow: inset 0 0 15px rgba(0,255,156,0.1); }
.fare-display { font-size: 3.5em; text-align: center; font-weight: bold; color: #fff; text-shadow: 0 0 15px var(--neon-green); margin: 0; }
.info-row { display: flex; justify-content: space-around; margin: 10px 0; }
.display { font-size: 1.4em; text-align: center; color: var(--neon-green); }
.label { font-size: 0.6em; color: #666; display: block; margin-bottom: 4px; }
.horse-container { height: 45px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
.horse { font-size: 35px; animation: trot 0.6s infinite steps(2); animation-play-state: paused; }
@keyframes trot { 0% { transform: translateX(-8px) rotate(-2deg); } 50% { transform: translateX(8px) rotate(2deg); } 100% { transform: translateX(-8px) rotate(-2deg); } }
.controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 5px; }
button { padding: 18px; font-size: 1.1em; background: var(--neon-green); color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 10px; }
#history-modal, #report-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.96); display: none; flex-direction: column; padding: 20px; z-index: 2000; }
.history-list { overflow-y: auto; flex-grow: 1; }
.history-item { background: #1a1a1a; margin-bottom: 10px; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--neon-green); }
.report-content { color: var(--soft-white); line-height: 1.8; }
.report-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; }
.report-val { color: var(--neon-green); font-weight: bold; }
.scanline { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 4px, 3px 100%; z-index: 0; }
#recenter-btn { position: absolute; bottom: 20px; right: 20px; width: 45px; height: 45px; background: white; border-radius: 50%; display: none; justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; }
</style>
</head>
<body>

<div id="map"><div id="recenter-btn" onclick="recenterMap()">ğŸ¯</div></div>

<div class="panel">
    <div class="scanline"></div>
    <div id="history-modal">
        <h2 style="margin-top:0">Driving History</h2>
        <div class="history-list" id="history-list"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button style="flex:1" onclick="toggleHistory()">ë‹«ê¸°</button>
            <button style="flex:1; background:var(--alert-red);" onclick="clearAllHistory()">ì „ì²´ì‚­ì œ</button>
        </div>
    </div>
    <div id="report-modal">
        <h2 style="margin-top:0; color:var(--neon-green);">Trip Report</h2>
        <div class="report-content" id="report-content"></div>
        <button style="margin-top:20px; width:100%;" onclick="closeReport()">í™•ì¸</button>
    </div>
    <div class="horse-container"><div class="horse" id="horse">ğŸ</div></div>
    <div class="fare-container"><div class="fare-display" id="fare">â‚© 4,800</div></div>
    <div class="info-row">
        <div class="display"><span class="label">TIME</span><span id="time">00:00:00</span></div>
        <div class="display"><span class="label">DISTANCE</span><span id="distance">0.00 km</span></div>
    </div>
    <div style="text-align:center;"><div id="speed" style="font-size: 1.2em; color: #888; font-weight: bold;">0 km/h</div></div>
    <div class="controls"><button id="btn">ì£¼í–‰ ì‹œì‘</button><button id="history-btn" onclick="toggleHistory()">ê¸°ë¡</button></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* --- INIT --- */
let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5216, 126.9241], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const navIcon = L.divIcon({ className: 'nav-container', html: '<div id="nav-arrow" class="nav-arrow"></div>', iconSize: [20, 20], iconAnchor: [10, 10] });
let marker = L.marker([37.5216, 126.9241], { icon: navIcon }).addTo(map);
let pathLine = L.polyline([], { color: '#007AFF', weight: 6, opacity: 0.7 }).addTo(map);

/* --- STATE --- */
let running = false;
let totalDistance = 0, totalSeconds = 0, currentSpeed = 0, maxTripSpeed = 0;
let extraFareUnits = 0, combinedProgress = 0, lastDistanceForFare = 0;
let lastPoint = null, timer = null, watchId = null, wakeLock = null;
let locationHistory = [], currentPathData = [];
let isUserInteracting = false, resumeTimeout = null;

// [ì‹ ê·œ] ë°±ê·¸ë¼ìš´ë“œ ë³µê·€ ì‹œ ì‹œê°„ ë³´ì •ìš©
let startTime = null; 

const fareEl = document.getElementById("fare"), timeEl = document.getElementById("time");
const distEl = document.getElementById("distance"), speedEl = document.getElementById("speed");
const horseEl = document.getElementById("horse"), btn = document.getElementById("btn");
const recenterBtn = document.getElementById('recenter-btn');

/* --- MAP INTERACTION --- */
document.getElementById('map').addEventListener('pointerdown', () => {
    isUserInteracting = true;
    recenterBtn.style.display = 'flex';
    if (resumeTimeout) clearTimeout(resumeTimeout);
});
document.getElementById('map').addEventListener('pointerup', () => {
    resumeTimeout = setTimeout(() => { isUserInteracting = false; recenterBtn.style.display = 'none'; }, 3000);
});
function recenterMap() { isUserInteracting = false; recenterBtn.style.display = 'none'; }

/* --- ìœ„ì¹˜ ì¶”ì  ì—”ì§„ (watchPositionìœ¼ë¡œ ë³€ê²½) --- */
function startTracking() {
    if (watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude: lat, longitude: lng, heading } = pos.coords;
        const now = Date.now();
        marker.setLatLng([lat, lng]);
        if (!isUserInteracting) map.panTo([lat, lng], { animate: true, duration: 0.8 });
        
        const arrow = document.getElementById('nav-arrow');
        if (arrow && heading !== null) arrow.style.transform = `rotate(${heading}deg)`;

        // ì†ë„ ê³„ì‚° (3ì´ˆ í‰ê· )
        locationHistory.push({ lat, lng, t: now });
        locationHistory = locationHistory.filter(p => now - p.t <= 3000);
        if (locationHistory.length >= 2) {
            const first = locationHistory[0], last = locationHistory[locationHistory.length - 1];
            currentSpeed = (L.latLng(first.lat, first.lng).distanceTo(L.latLng(last.lat, last.lng)) / ((last.t - first.t) / 1000)) * 3.6;
            if (running && currentSpeed > maxTripSpeed) maxTripSpeed = currentSpeed;
        }

        // ì£¼í–‰ ê±°ë¦¬ ë° ë³‘ì‚°ì œ ê³„ì‚°
        if (running && lastPoint) {
            const d = L.latLng(lastPoint.lat, lastPoint.lng).distanceTo(L.latLng(lat, lng));
            if (d > 1.5 && d < 60) {
                totalDistance += d;
                pathLine.addLatLng([lat, lng]);
                currentPathData.push([lat, lng]);
                
                // ë³‘ì‚°ì œ ì ìš© (1600m ì´ˆê³¼ ì‹œ)
                if (totalDistance > 1600) {
                    let dDelta = totalDistance - lastDistanceForFare;
                    if (lastDistanceForFare === 0) dDelta = totalDistance - 1600;
                    combinedProgress += (currentSpeed < 15.26) ? (1 / 30) : (dDelta / 131);
                    while (combinedProgress >= 1.0) { extraFareUnits++; combinedProgress -= 1.0; }
                    lastDistanceForFare = totalDistance;
                }
            }
        }
        lastPoint = { lat, lng, t: now };
    }, err => console.error(err), { enableHighAccuracy: true });
}

/* --- [ì‹ ê·œ] í™”ë©´ ê°€ì‹œì„± ê°ì§€ (ë°±ê·¸ë¼ìš´ë“œ ë³µê·€ ì‹œ ì‹œê°„ ë³´ì •) --- */
document.addEventListener("visibilitychange", () => {
    if (!document.hidden && running && startTime) {
        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë©ˆì¶˜ ì‹œê°„ì„ ì‹¤ì œ íë¥¸ ì‹œê°„ìœ¼ë¡œ ê°•ì œ ë™ê¸°í™”
        const realElapsed = Math.floor((Date.now() - startTime) / 1000);
        totalSeconds = realElapsed;
        updateUI();
    }
});

/* --- FARE --- */
function getSurchargeInfo() {
    const h = new Date().getHours();
    if ((h >= 22 && h < 23) || (h >= 2 && h < 4)) return { rate: 1.2, name: "ì‹¬ì•¼í• ì¦(20%)" };
    if (h >= 23 || h < 2) return { rate: 1.4, name: "ì‹¬ì•¼í• ì¦(40%)" };
    return { rate: 1.0, name: "ì¼ë°˜(0%)" };
}
function getFare() {
    const info = getSurchargeInfo();
    return Math.floor((4800 * info.rate + (extraFareUnits * 100 * info.rate)) / 10) * 10;
}

/* --- TRIP CONTROL --- */
btn.onclick = async () => {
    if (!running) {
        running = true; totalDistance = 0; totalSeconds = 0; extraFareUnits = 0; 
        combinedProgress = 0; lastDistanceForFare = 0; maxTripSpeed = 0;
        currentPathData = []; pathLine.setLatLngs([]);
        startTime = Date.now(); // [ìˆ˜ì •] ì‹œì‘ ì‹œê°„ ê¸°ë¡
        btn.innerText = "ì£¼í–‰ ì¢…ë£Œ"; btn.style.background = "var(--alert-red)";
        timer = setInterval(updateUI, 1000);
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    } else {
        running = false; clearInterval(timer);
        btn.innerText = "ì£¼í–‰ ì‹œì‘"; btn.style.background = "var(--neon-green)";
        if (wakeLock) wakeLock.release();
        const report = generateReportData();
        if (totalDistance > 50) saveRecord(report);
        showReport(report);
        updateUI();
    }
};

function updateUI() {
    if (running) {
        // setIntervalì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëŠë ¤ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë§¤ë²ˆ startTimeê³¼ ë¹„êµí•˜ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•¨
        totalSeconds = Math.floor((Date.now() - startTime) / 1000);
    }
    timeEl.innerText = new Date(totalSeconds * 1000).toISOString().substr(11, 8);
    distEl.innerText = (totalDistance / 1000).toFixed(2) + " km";
    const rs = Math.round(currentSpeed);
    speedEl.innerText = rs + " km/h";
    fareEl.innerText = "â‚© " + getFare().toLocaleString();
    horseEl.style.animationPlayState = (rs > 0 && running) ? "running" : "paused";
    if (rs > 0) horseEl.style.animationDuration = Math.max(0.15, 1 - (rs / 60)) + "s";
}

/* --- REPORT & HISTORY (ê¸°ì¡´ ë™ì¼) --- */
function generateReportData() {
    const avgSpeed = totalSeconds > 0 ? (totalDistance / totalSeconds) * 3.6 : 0;
    const surcharge = getSurchargeInfo();
    return { fare: fareEl.innerText, dist: distEl.innerText, time: timeEl.innerText, avgSpeed: avgSpeed.toFixed(1) + " km/h", maxSpeed: Math.round(maxTripSpeed) + " km/h", surcharge: surcharge.name, date: new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }), path: currentPathData };
}
function showReport(data) {
    const content = document.getElementById('report-content');
    content.innerHTML = `
        <div class="report-row"><span>ì´ ìš”ê¸ˆ</span><span class="report-val">${data.fare}</span></div>
        <div class="report-row"><span>ì£¼í–‰ ê±°ë¦¬</span><span class="report-val">${data.dist}</span></div>
        <div class="report-row"><span>ì£¼í–‰ ì‹œê°„</span><span class="report-val">${data.time}</span></div>
        <div class="report-row"><span>í‰ê·  ì†ë„</span><span class="report-val">${data.avgSpeed}</span></div>
        <div class="report-row"><span>ìµœê³  ì†ë„</span><span class="report-val">${data.maxSpeed}</span></div>
        <div class="report-row"><span>ì ìš© í• ì¦</span><span class="report-val">${data.surcharge}</span></div>
    `;
    document.getElementById('report-modal').style.display = 'flex';
}
function closeReport() { document.getElementById('report-modal').style.display = 'none'; }
function saveRecord(report) {
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    records.unshift({ id: Date.now(), ...report });
    localStorage.setItem('taxi_records', JSON.stringify(records));
}
function renderHistory() {
    const list = document.getElementById('history-list');
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    list.innerHTML = records.length ? '' : '<p style="color:#666; text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    records.forEach(r => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div><strong style="color:#fff;">${r.fare}</strong> | ${r.dist}<br><small style="color:#888;">${r.date}</small><br><span class="view-path-btn" onclick="showReportById(${r.id})">ë¦¬í¬íŠ¸</span> <span class="view-path-btn" style="background:#444" onclick="viewSnapshot('${encodeURIComponent(JSON.stringify(r.path))}')">ê²½ë¡œ</span></div><div style="color:var(--alert-red); cursor:pointer; padding:10px;" onclick="deleteRecord(${r.id})">âœ•</div>`;
        list.appendChild(item);
    });
}
function showReportById(id) {
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    const data = records.find(r => r.id === id);
    if (data) showReport(data);
}
function viewSnapshot(pathJson) {
    const path = JSON.parse(decodeURIComponent(pathJson));
    if (!path.length) return;
    toggleHistory();
    pathLine.setLatLngs(path);
    map.fitBounds(pathLine.getBounds(), { padding: [30, 30] });
}
function deleteRecord(id) {
    let records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    localStorage.setItem('taxi_records', JSON.stringify(records.filter(r => r.id !== id)));
    renderHistory();
}
function clearAllHistory() { if(confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) { localStorage.removeItem('taxi_records'); renderHistory(); } }
function toggleHistory() {
    const modal = document.getElementById('history-modal');
    modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    if (modal.style.display === 'flex') renderHistory();
}

// ì´ˆê¸° ì¶”ì  ì‹œì‘
startTracking();
</script>
</body>
</html>
