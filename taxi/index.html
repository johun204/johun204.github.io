<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Taxi Meter</title>

<link rel="icon" type="image/png" sizes="16x16" href="/taxi/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/taxi/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">
<link rel="manifest" href="/taxi/site.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Taxi Meter">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
:root { --neon-green: #00ff9c; --alert-red: #ff4b4b; --bg-dark: #0a0a0a; }
body {
    margin: 0; background: var(--bg-dark);
    font-family: 'Courier New', monospace; color: var(--neon-green);
    overflow: hidden; touch-action: manipulation;
}

#map { height: 42vh; width: 100%; border-bottom: 2px solid #222; }

.panel {
    height: 58vh; background: #111;
    padding: 15px; display: flex; flex-direction: column;
    justify-content: space-between; position: relative; box-sizing: border-box;
}

/* ìš”ê¸ˆì°½ ë””ìì¸ ê°•í™” */
.fare-container {
    background: #000; border: 2px solid #333; padding: 10px; border-radius: 12px;
    box-shadow: inset 0 0 15px rgba(0,255,156,0.1);
}
.fare-display {
    font-size: 3.5em; text-align: center; font-weight: bold;
    color: #fff; text-shadow: 0 0 15px var(--neon-green); margin: 0;
}

.info-row { display: flex; justify-content: space-around; margin: 10px 0; }
.display { font-size: 1.4em; text-align: center; color: var(--neon-green); }
.label { font-size: 0.6em; color: #666; display: block; margin-bottom: 4px; }

.horse-container { height: 45px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
.horse { font-size: 35px; animation: trot 0.6s infinite steps(2); animation-play-state: paused; }

@keyframes trot {
    0% { transform: translateX(-8px) rotate(-2deg); }
    50% { transform: translateX(8px) rotate(2deg); }
    100% { transform: translateX(-8px) rotate(-2deg); }
}

.controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 5px; }
button {
    padding: 18px; font-size: 1.1em; background: var(--neon-green);
    color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 10px;
    transition: transform 0.1s;
}
button:active { transform: scale(0.95); }
#history-btn { background: #222; color: var(--neon-green); border: 1px solid var(--neon-green); }

/* íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ */
#history-modal {
    position: absolute; inset: 0; background: rgba(0,0,0,0.95);
    display: none; flex-direction: column; padding: 20px; z-index: 2000;
}
.history-list { overflow-y: auto; flex-grow: 1; }
.history-item {
    background: #1a1a1a; margin-bottom: 10px; padding: 12px; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--neon-green);
}
.view-path-btn { background: #333; color: #fff; padding: 5px 8px; font-size: 0.7em; border-radius: 4px; margin-top: 5px; display: inline-block; }

.scanline {
    width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none;
    background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 3px 100%; z-index: 10;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="scanline"></div>
    
    <div id="history-modal">
        <h2 style="margin:0 0 15px 0;">Driving History</h2>
        <div class="history-list" id="history-list"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button style="flex:1" onclick="toggleHistory()">ë‹«ê¸°</button>
            <button style="flex:1; background:var(--alert-red);" onclick="clearAllHistory()">ì „ì²´ì‚­ì œ</button>
        </div>
    </div>

    <div class="horse-container"><div class="horse" id="horse">ğŸ</div></div>
    
    <div class="fare-container">
        <div class="fare-display" id="fare">â‚©4,800</div>
    </div>

    <div class="info-row">
        <div class="display"><span class="label">TIME</span><span id="time">00:00:00</span></div>
        <div class="display"><span class="label">DISTANCE</span><span id="distance">0.00 km</span></div>
    </div>
    
    <div style="text-align:center;">
        <div id="speed" style="font-size: 1.2em; color: #888; font-weight: bold;">0 km/h</div>
    </div>

    <div class="controls">
        <button id="btn">ì£¼í–‰ ì‹œì‘</button>
        <button id="history-btn" onclick="toggleHistory()">ê¸°ë¡</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* --- INIT MAP --- */
let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5665, 126.9780], 16);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let marker = L.marker([37.5665,126.9780]).addTo(map);
let pathLine = L.polyline([], { color: '#00ff9c', weight: 5, opacity: 0.8, lineJoin: 'round' }).addTo(map);

/* --- STATE VARIABLES --- */
let running = false;
let totalDistance = 0, totalSeconds = 0, lowSpeedSeconds = 0, currentSpeed = 0;
let lastPoint = null, timer = null, wakeLock = null;
let currentPathData = []; // Snapshotìš© ê²½ë¡œ ì €ì¥

const fareEl = document.getElementById("fare"), timeEl = document.getElementById("time");
const distEl = document.getElementById("distance"), speedEl = document.getElementById("speed");
const horseEl = document.getElementById("horse"), btn = document.getElementById("btn");

/* --- FARE CALCULATION (Seoul 2026 Standards) --- */
function getFare() {
    const now = new Date();
    const h = now.getHours();
    let rate = 1.0;
    
    // ì‹¬ì•¼ í• ì¦: 22-23(20%), 23-02(40%), 02-04(20%)
    if ((h >= 22 && h < 23) || (h >= 2 && h < 4)) rate = 1.2;
    else if (h >= 23 || h < 2) rate = 1.4;

    const BASE_FARE = 4800 * rate;
    const BASE_DIST = 1600; // 1.6km
    const DIST_UNIT = 131;  // 131më‹¹ 100ì›
    const TIME_UNIT = 30;   // 30ì´ˆë‹¹ 100ì› (15.26km/h ë¯¸ë§Œ ì‹œ)
    const STEP_FARE = 100 * rate;

    let extra = 0;
    if (totalDistance > BASE_DIST) {
        extra += Math.floor((totalDistance - BASE_DIST) / DIST_UNIT) * STEP_FARE;
    }
    if (lowSpeedSeconds > 0) {
        extra += Math.floor(lowSpeedSeconds / TIME_UNIT) * STEP_FARE;
    }

    return Math.floor((BASE_FARE + extra) / 10) * 10;
}

/* --- GPS & MOVEMENT --- */
navigator.geolocation.watchPosition(pos => {
    const { latitude: lat, longitude: lng, speed } = pos.coords;
    const now = Date.now();
    
    marker.setLatLng([lat, lng]);
    
    if (running) {
        map.panTo([lat, lng]);
        
        if (lastPoint) {
            const p1 = L.latLng(lastPoint.lat, lastPoint.lng);
            const p2 = L.latLng(lat, lng);
            const dist = p1.distanceTo(p2);
            
            // GPS íŠ€ëŠ” í˜„ìƒ ë°©ì§€ (ì •ì§€ ì¤‘ì´ê±°ë‚˜ ë„ˆë¬´ í° ë„ì•½ ì œì™¸)
            if (dist > 2 && dist < 50) {
                totalDistance += dist;
                pathLine.addLatLng([lat, lng]);
                currentPathData.push([lat, lng]);
            }
            
            // ì‹¤ì‹œê°„ ì†ë„ ê³„ì‚° (ê¸°ê¸° GPS ì†ë„ ìš°ì„ , ì—†ìœ¼ë©´ ê³„ì‚°)
            currentSpeed = (speed !== null) ? speed * 3.6 : (dist / ((now - lastPoint.t)/1000)) * 3.6;
        }
        lastPoint = { lat, lng, t: now };
    }
}, err => console.error(err), { enableHighAccuracy: true });

/* --- CONTROLS --- */
btn.onclick = async () => {
    if (!running) {
        // ì£¼í–‰ ì‹œì‘
        running = true; 
        totalDistance = 0; totalSeconds = 0; lowSpeedSeconds = 0; currentPathData = [];
        pathLine.setLatLngs([]);
        btn.innerText = "ì£¼í–‰ ì¢…ë£Œ"; btn.style.background = "var(--alert-red)";
        
        timer = setInterval(updateEngine, 1000);
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    } else {
        // ì£¼í–‰ ì¢…ë£Œ
        running = false; clearInterval(timer);
        btn.innerText = "ì£¼í–‰ ì‹œì‘"; btn.style.background = "var(--neon-green)";
        saveRecord();
        alert(`ìš´í–‰ ì¢…ë£Œ\nìµœì¢… ìš”ê¸ˆ: ${fareEl.innerText}`);
        if (wakeLock) wakeLock.release();
        currentSpeed = 0;
        updateEngine(); // UI ì´ˆê¸°í™”
    }
};

function updateEngine() {
    if (running) totalSeconds++;
    
    // ì‹œê°„ í‘œì‹œ
    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const s = String(totalSeconds % 60).padStart(2, '0');
    timeEl.innerText = `${h}:${m}:${s}`;
    
    // ê±°ë¦¬ í‘œì‹œ
    distEl.innerText = (totalDistance / 1000).toFixed(2) + " km";
    
    // ì†ë„ í‘œì‹œ ë° ì‹œê°„ ìš”ê¸ˆ íŒì •
    const roundedSpeed = Math.round(currentSpeed);
    speedEl.innerText = roundedSpeed + " km/h";
    if (running && currentSpeed < 15.26) lowSpeedSeconds++;

    // ë§ ì• ë‹ˆë©”ì´ì…˜ (ì†ë„ ì—°ë™)
    if (roundedSpeed > 0 && running) {
        horseEl.style.animationPlayState = "running";
        const duration = Math.max(0.15, 1 - (roundedSpeed / 60));
        horseEl.style.animationDuration = duration + "s";
    } else {
        horseEl.style.animationPlayState = "paused";
    }

    fareEl.innerText = "â‚©" + getFare().toLocaleString();
}

/* --- SNAPSHOT & HISTORY --- */
function saveRecord() {
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    const newRecord = {
        id: Date.now(),
        date: new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }),
        fare: fareEl.innerText,
        dist: distEl.innerText,
        time: timeEl.innerText,
        path: currentPathData // ê²½ë¡œ ìŠ¤ëƒ…ìƒ· ë°ì´í„° ì €ì¥
    };
    records.unshift(newRecord);
    localStorage.setItem('taxi_records', JSON.stringify(records));
}

function renderHistory() {
    const list = document.getElementById('history-list');
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    list.innerHTML = records.length ? '' : '<p style="color:#666; text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    
    records.forEach(r => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
            <div>
                <strong style="color:#fff; font-size:1.1em;">${r.fare}</strong><br>
                <small style="color:#888;">${r.date} (${r.time} / ${r.dist})</small><br>
                <span class="view-path-btn" onclick="viewSnapshot('${encodeURIComponent(JSON.stringify(r.path))}')">ê²½ë¡œ ë³´ê¸°</span>
            </div>
            <div style="color:var(--alert-red); cursor:pointer; padding:10px;" onclick="deleteRecord(${r.id})">âœ•</div>
        `;
        list.appendChild(item);
    });
}

function viewSnapshot(pathJson) {
    const path = JSON.parse(decodeURIComponent(pathJson));
    if (!path || path.length === 0) return alert("ê²½ë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
    
    toggleHistory(); // ëª¨ë‹¬ ë‹«ê¸°
    pathLine.setLatLngs(path); // ì €ì¥ëœ ê²½ë¡œ ê·¸ë¦¬ê¸°
    map.fitBounds(pathLine.getBounds(), { padding: [30, 30] }); // ê²½ë¡œì— ë§ì¶° ì§€ë„ ì¤Œ ì¡°ì ˆ
    alert("ê³¼ê±° ì£¼í–‰ ê²½ë¡œë¥¼ ì§€ë„ì— í‘œì‹œí–ˆìŠµë‹ˆë‹¤.");
}

function deleteRecord(id) {
    let records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    records = records.filter(r => r.id !== id);
    localStorage.setItem('taxi_records', JSON.stringify(records));
    renderHistory();
}

function clearAllHistory() {
    if(confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        localStorage.removeItem('taxi_records');
        renderHistory();
    }
}

function toggleHistory() {
    const modal = document.getElementById('history-modal');
    const isVisible = modal.style.display === 'flex';
    modal.style.display = isVisible ? 'none' : 'flex';
    if (!isVisible) renderHistory();
}
</script>
</body>
</html>
