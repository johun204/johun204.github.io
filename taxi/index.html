<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Taxi Meter</title>

<link rel="icon" type="image/png" sizes="16x16" href="/taxi/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/taxi/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">
<link rel="manifest" href="/taxi/site.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Taxi Meter">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
:root { --neon-green: #00ff9c; --alert-red: #ff4b4b; --bg-dark: #0a0a0a; }
body {
    margin: 0; background: var(--bg-dark);
    font-family: 'Courier New', monospace; color: var(--neon-green);
    overflow: hidden; touch-action: manipulation;
}

#map { height: 42vh; width: 100%; background: #f0f0f0; }

.panel {
    height: 58vh; background: #111;
    padding: 15px; display: flex; flex-direction: column;
    justify-content: space-between; position: relative; box-sizing: border-box;
    z-index: 1;
}
.panel > *:not(.scanline) { position: relative; z-index: 2; }

.nav-arrow {
    width: 0; height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 20px solid #007AFF;
    filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
    transform-origin: center;
    transition: transform 0.2s ease-out;
}

.fare-container {
    background: #000; border: 2px solid #333; padding: 10px; border-radius: 12px;
    box-shadow: inset 0 0 15px rgba(0,255,156,0.1);
}
.fare-display {
    font-size: 3.5em; text-align: center; font-weight: bold;
    color: #fff; text-shadow: 0 0 15px var(--neon-green); margin: 0;
}

.info-row { display: flex; justify-content: space-around; margin: 10px 0; }
.display { font-size: 1.4em; text-align: center; color: var(--neon-green); }
.label { font-size: 0.6em; color: #666; display: block; margin-bottom: 4px; }

.horse-container { height: 45px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
.horse { font-size: 35px; animation: trot 0.6s infinite steps(2); animation-play-state: paused; }

@keyframes trot {
    0% { transform: translateX(-8px) rotate(-2deg); }
    50% { transform: translateX(8px) rotate(2deg); }
    100% { transform: translateX(-8px) rotate(-2deg); }
}

.controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 5px; }
button {
    padding: 18px; font-size: 1.1em; background: var(--neon-green);
    color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 10px;
    transition: transform 0.1s;
}
button:active { transform: scale(0.95); }
#history-btn { background: #222; color: var(--neon-green); border: 1px solid var(--neon-green); }

#history-modal {
    position: absolute; inset: 0; background: rgba(0,0,0,0.95);
    display: none; flex-direction: column; padding: 20px; z-index: 2000;
}
.history-list { overflow-y: auto; flex-grow: 1; }
.history-item {
    background: #1a1a1a; margin-bottom: 10px; padding: 12px; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--neon-green);
}
.view-path-btn { background: #333; color: #fff; padding: 5px 8px; font-size: 0.7em; border-radius: 4px; margin-top: 5px; display: inline-block; }

.scanline {
    width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none;
    background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 3px 100%; z-index: 0;
}

#recenter-btn {
    position: absolute; bottom: 20px; right: 20px; width: 45px; height: 45px;
    background: white; border-radius: 50%; display: none;
    justify-content: center; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    cursor: pointer; z-index: 1000; transition: transform 0.1s;
}

/* --- ì»¤ìŠ¤í…€ ì•Œë¦¼ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ --- */
.custom-alert-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    display: none; justify-content: center; align-items: center; z-index: 9999;
}
.alert-box {
    background: #1a1a1a; border: 2px solid var(--neon-green); padding: 30px;
    border-radius: 20px; text-align: center; width: 80%; max-width: 400px;
}
.alert-box h3 { margin: 0 0 15px 0; color: #fff; }
.alert-box p { font-size: 1.2em; color: var(--neon-green); margin-bottom: 25px; }
.alert-box button { width: 100%; }

/* ìƒë‹¨ ë…¸í‹°ë°” (ì£¼í–‰ ì¤‘ ì°¨ë‹¨ìš©) */
#notice-bar {
    position: fixed; top: -100px; left: 0; width: 100%; background: var(--alert-red);
    color: white; padding: 15px; text-align: center; font-weight: bold;
    z-index: 10000; transition: top 0.3s;
}
</style>
</head>
<body>

<div id="notice-bar">í˜„ì¬ ì£¼í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¢…ë£Œ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.</div>

<div id="custom-alert" class="custom-alert-overlay">
    <div class="alert-box">
        <h3 id="alert-title">ìš´í–‰ ì •ë³´</h3>
        <p id="alert-msg"></p>
        <button onclick="closeAlert()">í™•ì¸</button>
    </div>
</div>

<div id="map">
    <div id="recenter-btn" onclick="recenterMap()">
        <span style="font-size: 20px;">ğŸ¯</span>
    </div>
</div>

<div class="panel">
    <div class="scanline"></div>
    
    <div id="history-modal">
        <h2 style="margin:0 0 15px 0;">Driving History</h2>
        <div class="history-list" id="history-list"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button style="flex:1" onclick="toggleHistory()">ë‹«ê¸°</button>
            <button style="flex:1; background:var(--alert-red);" onclick="clearAllHistory()">ì „ì²´ì‚­ì œ</button>
        </div>
    </div>

    <div class="horse-container"><div class="horse" id="horse">ğŸ</div></div>
    
    <div class="fare-container">
        <div class="fare-display" id="fare">â‚© 4,800</div>
    </div>

    <div class="info-row">
        <div class="display"><span class="label">TIME</span><span id="time">00:00:00</span></div>
        <div class="display"><span class="label">DISTANCE</span><span id="distance">0.00 km</span></div>
    </div>
    
    <div style="text-align:center;">
        <div id="speed" style="font-size: 1.2em; color: #888; font-weight: bold;">0 km/h</div>
    </div>

    <div class="controls">
        <button id="btn">ì£¼í–‰ ì‹œì‘</button>
        <button id="history-btn" onclick="toggleHistory()">ê¸°ë¡</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* --- INIT MAP --- */
let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5216, 126.9241], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const navIcon = L.divIcon({
    className: 'nav-icon-container',
    html: '<div id="nav-arrow" class="nav-arrow"></div>',
    iconSize: [20, 20],
    iconAnchor: [10, 10]
});
let marker = L.marker([37.5216, 126.9241], { icon: navIcon }).addTo(map);
let pathLine = L.polyline([], { color: '#007AFF', weight: 6, opacity: 0.7, lineJoin: 'round' }).addTo(map);

/* --- STATE --- */
let running = false;
let totalDistance = 0, totalSeconds = 0, lowSpeedSeconds = 0;
let currentSpeed = 0; // ë³´ì •ëœ í˜„ì¬ ì†ë„
let lastPoint = null, timer = null, gpsTimer = null, wakeLock = null;
let currentPathData = [];
let isUserInteracting = false, resumeTimeout = null;

const fareEl = document.getElementById("fare"), timeEl = document.getElementById("time");
const distEl = document.getElementById("distance"), speedEl = document.getElementById("speed");
const horseEl = document.getElementById("horse"), btn = document.getElementById("btn");
const recenterBtn = document.getElementById('recenter-btn');

/* --- MAP EVENTS --- */
const mapContainer = document.getElementById('map');
mapContainer.addEventListener('pointerdown', () => {
    isUserInteracting = true;
    recenterBtn.style.display = 'flex';
    if (resumeTimeout) clearTimeout(resumeTimeout);
});
mapContainer.addEventListener('pointerup', () => {
    if (resumeTimeout) clearTimeout(resumeTimeout);
    resumeTimeout = setTimeout(() => { isUserInteracting = false; recenterBtn.style.display = 'none'; }, 3000);
});
function recenterMap() {
    isUserInteracting = false; recenterBtn.style.display = 'none';
    if (lastPoint) map.setView([lastPoint.lat, lastPoint.lng], 17, { animate: true });
}

/* --- ê³ ì† ìœ„ì¹˜ ì¶”ì  ì—”ì§„ (ì†ë„ íŠ€ëŠ” í˜„ìƒ ë°©ì§€ ë¡œì§ í¬í•¨) --- */
function updateLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lng, speed: gpsSpeed, heading } = pos.coords;
        const now = Date.now();
        const arrow = document.getElementById('nav-arrow');
        
        marker.setLatLng([lat, lng]);
        if (!isUserInteracting) map.panTo([lat, lng], { animate: true, duration: 0.5 });
        
        if (arrow) {
            if (heading !== null && !isNaN(heading)) arrow.style.transform = `rotate(${heading}deg)`;
            else if (lastPoint) {
                const angle = Math.atan2(lng - lastPoint.lng, lat - lastPoint.lat) * 180 / Math.PI;
                arrow.style.transform = `rotate(${angle}deg)`;
            }
        }
        
        if (lastPoint) {
            const p1 = L.latLng(lastPoint.lat, lastPoint.lng), p2 = L.latLng(lat, lng);
            const dist = p1.distanceTo(p2);
            
            // 1. ì‹¤ì œ ê³„ì‚°ëœ ì†ë„ (km/h)
            let rawSpeed = (gpsSpeed !== null && gpsSpeed >= 0) ? gpsSpeed * 3.6 : (dist / ((now - lastPoint.t)/1000)) * 3.6;

            // 2. [ì†ë„ íŠ ë°©ì§€] 150km/hê°€ ë„˜ëŠ” ë„ì•½ì€ GPS ì˜¤ì°¨ë¡œ ê°„ì£¼í•˜ê³  ë¬´ì‹œ
            if (rawSpeed > 150) rawSpeed = currentSpeed; 

            // 3. [ì´ë™ í‰ê·  í•„í„°] ì´ì „ ì†ë„ì™€ í˜„ì¬ ì†ë„ë¥¼ ì„ì–´ì„œ ê¸‰ê²©í•œ ë³€í™” ì–µì œ (Smoothing)
            currentSpeed = (currentSpeed * 0.6) + (rawSpeed * 0.4);

            if (running) {
                // ì£¼í–‰ ì¤‘ì¼ ë•ŒëŠ” 1.5m ì´ìƒì˜ ìœ ì˜ë¯¸í•œ ì´ë™ë§Œ ê¸°ë¡
                if (dist > 1.5 && dist < 50) {
                    totalDistance += dist;
                    pathLine.addLatLng([lat, lng]);
                    currentPathData.push([lat, lng]);
                }
            }
        }
        lastPoint = { lat, lng, t: now };
    }, null, { enableHighAccuracy: true, timeout: 1000 });
}
gpsTimer = setInterval(updateLocation, 500);

/* --- CUSTOM ALERT SYSTEM --- */
function showAlert(title, msg) {
    document.getElementById('alert-title').innerText = title;
    document.getElementById('alert-msg').innerText = msg;
    document.getElementById('custom-alert').style.display = 'flex';
}
function closeAlert() { document.getElementById('custom-alert').style.display = 'none'; }

function showNotice() {
    const bar = document.getElementById('notice-bar');
    bar.style.top = '0';
    setTimeout(() => { bar.style.top = '-100px'; }, 2000);
}

/* --- FARE & UI --- */
function getFare() {
    const h = new Date().getHours();
    let rate = (h >= 22 && h < 23) || (h >= 2 && h < 4) ? 1.2 : (h >= 23 || h < 2 ? 1.4 : 1.0);
    const extra = (totalDistance > 1600 ? Math.floor((totalDistance - 1600) / 131) * (100 * rate) : 0) + (Math.floor(lowSpeedSeconds / 30) * (100 * rate));
    return Math.floor((4800 * rate + extra) / 10) * 10;
}

btn.onclick = async () => {
    if (!running) {
        running = true; totalDistance = 0; totalSeconds = 0; lowSpeedSeconds = 0; currentPathData = [];
        pathLine.setLatLngs([]); btn.innerText = "ì£¼í–‰ ì¢…ë£Œ"; btn.style.background = "var(--alert-red)";
        updateUI();
        timer = setInterval(updateUI, 1000);
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    } else {
        running = false; clearInterval(timer);
        const finalFare = fareEl.innerText;
        btn.innerText = "ì£¼í–‰ ì‹œì‘"; btn.style.background = "var(--neon-green)";
        saveRecord();
        if (wakeLock) wakeLock.release();
        updateUI();
        // ì£¼í–‰ ì¢…ë£Œ ë ˆì´ì–´ ì•Œë¦¼
        showAlert("ìš´í–‰ ì™„ë£Œ", `ì£¼í–‰ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nìš”ê¸ˆ: ${finalFare}`);
    }
};

function updateUI() {
    if (running) totalSeconds++;
    timeEl.innerText = new Date(totalSeconds * 1000).toISOString().substr(11, 8);
    distEl.innerText = (totalDistance / 1000).toFixed(2) + " km";
    const roundedSpeed = Math.round(currentSpeed);
    speedEl.innerText = roundedSpeed + " km/h";
    if (running && currentSpeed < 15.26) lowSpeedSeconds++;
    horseEl.style.animationPlayState = (roundedSpeed > 0 && running) ? "running" : "paused";
    if (roundedSpeed > 0) horseEl.style.animationDuration = Math.max(0.15, 1 - (roundedSpeed / 60)) + "s";
    fareEl.innerText = "â‚© " + getFare().toLocaleString();
}

function saveRecord() {
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    records.unshift({ id: Date.now(), date: new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }), fare: fareEl.innerText, dist: distEl.innerText, time: timeEl.innerText, path: currentPathData });
    localStorage.setItem('taxi_records', JSON.stringify(records));
}

function renderHistory() {
    const list = document.getElementById('history-list');
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    list.innerHTML = records.length ? '' : '<p style="color:#666; text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    records.forEach(r => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div><strong style="color:#fff;">${r.fare}</strong><br><small style="color:#888;">${r.date}</small><br><span class="view-path-btn" onclick="viewSnapshot('${encodeURIComponent(JSON.stringify(r.path))}')">ê²½ë¡œ ë³´ê¸°</span></div><div style="color:var(--alert-red); cursor:pointer;" onclick="deleteRecord(${r.id})">âœ•</div>`;
        list.appendChild(item);
    });
}

function viewSnapshot(pathJson) {
    // ì£¼í–‰ ì¤‘ ê²½ë¡œë³´ê¸° í´ë¦­ ì°¨ë‹¨
    if (running) {
        showNotice();
        return;
    }
    const path = JSON.parse(decodeURIComponent(pathJson));
    if (!path.length) return;
    toggleHistory();
    pathLine.setLatLngs(path);
    map.fitBounds(pathLine.getBounds(), { padding: [30, 30] });
}

function deleteRecord(id) {
    let records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    localStorage.setItem('taxi_records', JSON.stringify(records.filter(r => r.id !== id)));
    renderHistory();
}
function clearAllHistory() { if(confirm("ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) { localStorage.removeItem('taxi_records'); renderHistory(); } }
function toggleHistory() {
    const modal = document.getElementById('history-modal');
    modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    if (modal.style.display === 'flex') renderHistory();
}
</script>
</body>
</html>
