<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Taxi Meter</title>

<link rel="icon" type="image/png" sizes="16x16" href="/taxi/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/taxi/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">
<link rel="manifest" href="/taxi/site.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Taxi Meter">
<link rel="apple-touch-icon" sizes="180x180" href="/taxi/apple-touch-icon.png">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
:root { --neon-green: #00ff9c; --alert-red: #ff4b4b; --bg-dark: #0a0a0a; }
body {
    margin: 0; background: var(--bg-dark);
    font-family: 'Courier New', monospace; color: var(--neon-green);
    overflow: hidden; touch-action: manipulation;
}

#map { height: 42vh; width: 100%; background: #f0f0f0; }

.panel {
    height: 58vh; background: #111;
    padding: 15px; display: flex; flex-direction: column;
    justify-content: space-between; position: relative; box-sizing: border-box;
    z-index: 1;
}
.panel > *:not(.scanline) {
    position: relative;
    z-index: 2;
}
/* ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò ÌôîÏÇ¥Ìëú Ïä§ÌÉÄÏùº */
.nav-arrow {
    width: 0; height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 20px solid #007AFF;
    filter: drop-shadow(0 0 5px rgba(0,0,0,0.3));
    transform-origin: center;
    transition: transform 0.2s ease-out; /* ÌöåÏ†Ñ Î∂ÄÎìúÎüΩÍ≤å */
}

.fare-container {
    background: #000; border: 2px solid #333; padding: 10px; border-radius: 12px;
    box-shadow: inset 0 0 15px rgba(0,255,156,0.1);
}
.fare-display {
    font-size: 3.5em; text-align: center; font-weight: bold;
    color: #fff; text-shadow: 0 0 15px var(--neon-green); margin: 0;
}

.info-row { display: flex; justify-content: space-around; margin: 10px 0; }
.display { font-size: 1.4em; text-align: center; color: var(--neon-green); }
.label { font-size: 0.6em; color: #666; display: block; margin-bottom: 4px; }

.horse-container { height: 45px; display: flex; justify-content: center; align-items: center; overflow: hidden; }
.horse { font-size: 35px; animation: trot 0.6s infinite steps(2); animation-play-state: paused; }

@keyframes trot {
    0% { transform: translateX(-8px) rotate(-2deg); }
    50% { transform: translateX(8px) rotate(2deg); }
    100% { transform: translateX(-8px) rotate(-2deg); }
}

.controls { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-top: 5px; }
button {
    padding: 18px; font-size: 1.1em; background: var(--neon-green);
    color: black; border: none; font-weight: bold; cursor: pointer; border-radius: 10px;
    transition: transform 0.1s;
}
button:active { transform: scale(0.95); }
#history-btn { background: #222; color: var(--neon-green); border: 1px solid var(--neon-green); }

#history-modal {
    position: absolute; inset: 0; background: rgba(0,0,0,0.95);
    display: none; flex-direction: column; padding: 20px; z-index: 2000;
}
.history-list { overflow-y: auto; flex-grow: 1; }
.history-item {
    background: #1a1a1a; margin-bottom: 10px; padding: 12px; border-radius: 8px;
    display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--neon-green);
}
.view-path-btn { background: #333; color: #fff; padding: 5px 8px; font-size: 0.7em; border-radius: 4px; margin-top: 5px; display: inline-block; }

.scanline {
    width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none;
    background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 3px 100%; z-index: 0;
}

</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
    <div class="scanline"></div>
    
    <div id="history-modal">
        <h2 style="margin:0 0 15px 0;">Driving History</h2>
        <div class="history-list" id="history-list"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button style="flex:1" onclick="toggleHistory()">Îã´Í∏∞</button>
            <button style="flex:1; background:var(--alert-red);" onclick="clearAllHistory()">Ï†ÑÏ≤¥ÏÇ≠Ï†ú</button>
        </div>
    </div>

    <div class="horse-container"><div class="horse" id="horse">üêé</div></div>
    
    <div class="fare-container">
        <div class="fare-display" id="fare">‚Ç©4,800</div>
    </div>

    <div class="info-row">
        <div class="display"><span class="label">TIME</span><span id="time">00:00:00</span></div>
        <div class="display"><span class="label">DISTANCE</span><span id="distance">0.00 km</span></div>
    </div>
    
    <div style="text-align:center;">
        <div id="speed" style="font-size: 1.2em; color: #888; font-weight: bold;">0 km/h</div>
    </div>

    <div class="controls">
        <button id="btn">Ï£ºÌñâ ÏãúÏûë</button>
        <button id="history-btn" onclick="toggleHistory()">Í∏∞Î°ù</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* --- INIT MAP (Bright Mode) --- */
let map = L.map('map', { zoomControl: false, attributionControl: false }).setView([37.5216, 126.9241], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* --- NAV ARROW --- */
const navIcon = L.divIcon({
    className: 'nav-icon-container',
    html: '<div id="nav-arrow" class="nav-arrow"></div>',
    iconSize: [20, 20],
    iconAnchor: [10, 10]
});
let marker = L.marker([37.5216, 126.9241], { icon: navIcon }).addTo(map);
let pathLine = L.polyline([], { color: '#007AFF', weight: 6, opacity: 0.7, lineJoin: 'round' }).addTo(map);

/* --- STATE --- */
let running = false;
let totalDistance = 0, totalSeconds = 0, lowSpeedSeconds = 0, currentSpeed = 0;
let lastPoint = null, timer = null, gpsTimer = null, wakeLock = null;
let currentPathData = [];

const fareEl = document.getElementById("fare"), timeEl = document.getElementById("time");
const distEl = document.getElementById("distance"), speedEl = document.getElementById("speed");
const horseEl = document.getElementById("horse"), btn = document.getElementById("btn");

/* --- Í≥†ÏÜç ÏúÑÏπò Ï∂îÏ†Å ÏóîÏßÑ (500ms) --- */
function updateLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lng, speed, heading } = pos.coords;
        const now = Date.now();
        const arrow = document.getElementById('nav-arrow');
        
        marker.setLatLng([lat, lng]);
		// ÏßÄÎèÑ Î∂ÄÎìúÎüΩÍ≤å Ïù¥Îèô (500ms Ï£ºÍ∏∞Ïóê ÎßûÏ∂ò Ïï†ÎãàÎ©îÏù¥ÏÖò)
		map.panTo([lat, lng], { animate: true, duration: 0.5 });
        
        // Î∞©Ìñ• Ï≤òÎ¶¨
        if (arrow) {
            if (heading !== null && !isNaN(heading)) {
                arrow.style.transform = `rotate(${heading}deg)`;
            } else if (lastPoint) {
                const angle = Math.atan2(lng - lastPoint.lng, lat - lastPoint.lat) * 180 / Math.PI;
                arrow.style.transform = `rotate(${angle}deg)`;
            }
        }
        
        if (running) {
            
            if (lastPoint) {
                const p1 = L.latLng(lastPoint.lat, lastPoint.lng);
                const p2 = L.latLng(lat, lng);
                const dist = p1.distanceTo(p2);
                
                if (dist > 1.5 && dist < 50) { // 500ms Ï£ºÍ∏∞Ïóê ÎßûÏ∂∞ Í∞êÎèÑ ÏÉÅÌñ•
                    totalDistance += dist;
                    pathLine.addLatLng([lat, lng]);
                    currentPathData.push([lat, lng]);
                }
                currentSpeed = (speed !== null) ? speed * 3.6 : (dist / ((now - lastPoint.t)/1000)) * 3.6;
            }
            lastPoint = { lat, lng, t: now };
        }
    }, null, { enableHighAccuracy: true, timeout: 1000 });
}

// Ï¥àÍ∏∞ ÏúÑÏπò Ï∂îÏ†Å ÏãúÏûë
gpsTimer = setInterval(updateLocation, 500);

/* --- FARE & UI ENGINE --- */
function getFare() {
    const h = new Date().getHours();
    let rate = 1.0;
    if ((h >= 22 && h < 23) || (h >= 2 && h < 4)) rate = 1.2;
    else if (h >= 23 || h < 2) rate = 1.4;

    const BASE_FARE = 4800 * rate;
    const extra = (totalDistance > 1600 ? Math.floor((totalDistance - 1600) / 131) * (100 * rate) : 0) +
                  (Math.floor(lowSpeedSeconds / 30) * (100 * rate));
    return Math.floor((BASE_FARE + extra) / 10) * 10;
}

btn.onclick = async () => {
    if (!running) {
        running = true; totalDistance = 0; totalSeconds = 0; lowSpeedSeconds = 0; currentPathData = [];
        pathLine.setLatLngs([]); btn.innerText = "Ï£ºÌñâ Ï¢ÖÎ£å"; btn.style.background = "var(--alert-red)";
        timer = setInterval(updateUI, 1000);
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e) {}
    } else {
        running = false; clearInterval(timer);
        btn.innerText = "Ï£ºÌñâ ÏãúÏûë"; btn.style.background = "var(--neon-green)";
        saveRecord();
        if (wakeLock) wakeLock.release();
        updateUI();
    }
};

function updateUI() {
    if (running) totalSeconds++;
    const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
    const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
    const s = String(totalSeconds % 60).padStart(2, '0');
    timeEl.innerText = `${h}:${m}:${s}`;
    distEl.innerText = (totalDistance / 1000).toFixed(2) + " km";
    const roundedSpeed = Math.round(currentSpeed);
    speedEl.innerText = roundedSpeed + " km/h";
    
    if (running && currentSpeed < 15.26) lowSpeedSeconds++;

    if (roundedSpeed > 0 && running) {
        horseEl.style.animationPlayState = "running";
        horseEl.style.animationDuration = Math.max(0.15, 1 - (roundedSpeed / 60)) + "s";
    } else {
        horseEl.style.animationPlayState = "paused";
    }
    fareEl.innerText = "‚Ç©" + getFare().toLocaleString();
}

/* --- HISTORY --- */
function saveRecord() {
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    records.unshift({
        id: Date.now(),
        date: new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' }),
        fare: fareEl.innerText, dist: distEl.innerText, time: timeEl.innerText, path: currentPathData
    });
    localStorage.setItem('taxi_records', JSON.stringify(records));
}

function renderHistory() {
    const list = document.getElementById('history-list');
    const records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    list.innerHTML = records.length ? '' : '<p style="color:#666; text-align:center;">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
    records.forEach(r => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div><strong style="color:#fff;">${r.fare}</strong><br><small style="color:#888;">${r.date}</small><br><span class="view-path-btn" onclick="viewSnapshot('${encodeURIComponent(JSON.stringify(r.path))}')">Í≤ΩÎ°ú Î≥¥Í∏∞</span></div><div style="color:var(--alert-red); cursor:pointer;" onclick="deleteRecord(${r.id})">‚úï</div>`;
        list.appendChild(item);
    });
}

function viewSnapshot(pathJson) {
    const path = JSON.parse(decodeURIComponent(pathJson));
    if (!path.length) return;
    toggleHistory();
    pathLine.setLatLngs(path);
    map.fitBounds(pathLine.getBounds(), { padding: [30, 30] });
}

function deleteRecord(id) {
    let records = JSON.parse(localStorage.getItem('taxi_records') || '[]');
    localStorage.setItem('taxi_records', JSON.stringify(records.filter(r => r.id !== id)));
    renderHistory();
}

function clearAllHistory() {
    if(confirm("Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌï†ÍπåÏöî?")) { localStorage.removeItem('taxi_records'); renderHistory(); }
}

function toggleHistory() {
    const modal = document.getElementById('history-modal');
    modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    if (modal.style.display === 'flex') renderHistory();
}
</script>
</body>
</html>
