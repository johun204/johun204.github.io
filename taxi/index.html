<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi Meter</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body {
  margin: 0;
  background: #0a0a0a;
  font-family: 'Courier New', monospace;
  color: #00ff9c;
}

/* MAP */
#map {
  height: 55vh;
  filter: contrast(1.2) brightness(0.9);
}

/* PANEL */
.panel {
  height: 45vh;
  background: #111;
  border-top: 4px solid #00ff9c;
  padding: 14px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

/* DISPLAY */
.display {
  font-size: 2.4em;
  text-align: center;
  letter-spacing: 2px;
  text-shadow: 0 0 10px #00ff9c;
}

/* HORSE */
.horse {
  font-size: 38px;
  text-align: center;
  animation: trot 0.6s infinite steps(2);
}

@keyframes trot {
  0% { transform: translateX(0); }
  50% { transform: translateX(6px); }
  100% { transform: translateX(0); }
}

/* BUTTON */
button {
  padding: 16px;
  font-size: 1.3em;
  background: #00ff9c;
  color: black;
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button:active {
  background: #009966;
}

/* CRT SCANLINE */
.panel::after {
  content: "";
  position: absolute;
  inset: 0;
  background: repeating-linear-gradient(
    to bottom,
    rgba(255,255,255,0.03),
    rgba(255,255,255,0.03) 1px,
    transparent 2px,
    transparent 4px
  );
  pointer-events: none;
}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <div class="horse" id="horse">üêé</div>

  <div class="display" id="time">00Ï¥à</div>
  <div class="display" id="distance">0.00 km</div>
  <div class="display" id="fare">‚Ç©4,800</div>

  <button id="btn">Ï£ºÌñâ ÏãúÏûë</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([37.5665, 126.9780], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marker = L.marker([37.5665,126.9780]).addTo(map);
let pathLine = L.polyline([], { color:'#00ff9c' }).addTo(map);

let watchId = null;
let running = false;
let startTime = null;
let lastPoint = null;
let totalDistance = 0;
let seconds = 0;
let timer = null;

const timeEl = document.getElementById("time");
const distEl = document.getElementById("distance");
const fareEl = document.getElementById("fare");
const horseEl = document.getElementById("horse");
const btn = document.getElementById("btn");

/* WAKE LOCK */
let wakeLock = null;
async function enableWakeLock() {
  try { wakeLock = await navigator.wakeLock.request('screen'); } catch {}
}

/* DISTANCE */
function calcDistance(a,b){
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLon=(b.lng-a.lng)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* SPEED */
function calcSpeed(a,b){
  const d = calcDistance(a,b);
  const dt = (b.t-a.t)/1000;
  return dt>0 ? (d/dt)*3.6 : 0;
}

/* TIME FORMAT */
function formatTime(sec){
  let h=Math.floor(sec/3600);
  let m=Math.floor((sec%3600)/60);
  let s=sec%60;
  let out=[];
  if(h>0) out.push(h+"ÏãúÍ∞Ñ");
  if(m>0 || h>0) out.push(m+"Î∂Ñ");
  out.push(s+"Ï¥à");
  return out.join(" ");
}

/* SEOUL TAXI ENGINE */
function calcFare(sec, meters, speed){
  const BASE=4800;
  const BASE_DIST=1600;
  const DIST_UNIT=131;
  const TIME_UNIT=30;
  const STEP=100;
  const LOW_SPEED=15.72;

  let extra=0;

  if(meters>BASE_DIST){
    extra += Math.floor((meters-BASE_DIST)/DIST_UNIT)*STEP;
  }

  if(speed<LOW_SPEED && sec>0){
    extra += Math.floor(sec/TIME_UNIT)*STEP;
  }

  let h=new Date().getHours();
  let rate=1;
  if(h>=22 && h<23) rate=1.2;
  if(h>=23 || h<4) rate=1.4;

  extra *= rate;
  let fare = BASE + extra;
  return Math.round(fare/10)*10;
}

/* GPS ALWAYS ON */
navigator.geolocation.watchPosition(pos=>{
  const now = Date.now();
  const point = {lat:pos.coords.latitude, lng:pos.coords.longitude, t:now};

  marker.setLatLng([point.lat,point.lng]);
  map.setView([point.lat,point.lng], map.getZoom());

  if(running && (!lastPoint || now-lastPoint.t>=5000)){
    if(lastPoint){
      totalDistance += calcDistance(lastPoint, point);
      pathLine.addLatLng([point.lat, point.lng]);
    }
    lastPoint = point;
  }
});

/* TIMER */
function startTimer(){
  timer = setInterval(()=>{
    seconds++;
    timeEl.innerText = formatTime(seconds);

    let km = (totalDistance/1000).toFixed(2);
    distEl.innerText = km + " km";

    let speed = lastPoint ? calcSpeed(lastPoint,lastPoint) : 0;
    let fare = calcFare(seconds,totalDistance,speed);

    fareEl.innerText = "‚Ç©" + fare.toLocaleString();

    /* Horse speed animation */
    horseEl.style.animationDuration = speed>20 ? "0.2s" : speed>5 ? "0.4s" : "0.7s";

  },1000);
}

/* BUTTON */
btn.onclick = ()=>{
  if(!running){
    running = true;
    enableWakeLock();
    btn.innerText = "Ï¢ÖÎ£å";
    seconds = 0;
    totalDistance = 0;
    pathLine.setLatLngs([]);
    startTime = Date.now();
    lastPoint = null;
    startTimer();
  } else {
    running = false;
    clearInterval(timer);
    btn.innerText = "Ï£ºÌñâ ÏãúÏûë";
    alert("ÏµúÏ¢Ö ÏöîÍ∏à: ‚Ç©" + fareEl.innerText.replace("‚Ç©",""));
  }
};
</script>
</body>
</html>
